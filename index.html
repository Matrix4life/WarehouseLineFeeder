<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Warehouse Line Feeder</title>

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#00ff88">
<link rel="apple-touch-icon" href="./icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{margin:0;background:#0a0e1a;color:#e8fff4;font-family:system-ui}
.loading{display:flex;align-items:center;justify-content:center;height:100vh}
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const CONFIG = {
  ENABLE_SUPABASE: true,
  SUPABASE_URL: "https://vryxhveadpvhgvhyyary.supabase.co",
  SUPABASE_ANON_KEY: "sb_publishable_vKIZKhITzYfAJqfg-O-Zbw_4UXI1U8e",
  REFRESH_MS: 2500,
};

const supabase = window.supabase.createClient(
  CONFIG.SUPABASE_URL,
  CONFIG.SUPABASE_ANON_KEY
);

function App(){
  const [loading,setLoading]=React.useState(true);
  const [rows,setRows]=React.useState([]);

  async function loadRequestsFromSupabase(){
    try{
      const {data,error} = await supabase
        .from("warehouse_requests")
        .select("*")
        .order("submitted_at",{ascending:false});
      if(error){ console.error(error); return []; }
      return Array.isArray(data)?data:[];
    }catch(e){
      console.error(e);
      return [];
    }
  }

  async function refresh(){
    setLoading(true);
    try{
      const data = await loadRequestsFromSupabase();
      setRows(data);
    } finally {
      setLoading(false);
    }
  }

  React.useEffect(()=>{
    refresh();
    const id = setInterval(refresh, CONFIG.REFRESH_MS);
    return ()=>clearInterval(id);
  },[]);

  if(loading) return <div className="loading">Loading…</div>;

  return (
    <div style={{padding:16}}>
      <h2>Requests ({rows.length})</h2>
      <ul>
        {rows.map(r=>(
          <li key={r.id}>
            {r.item} — {r.room} — {r.qty}
          </li>
        ))}
      </ul>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>
