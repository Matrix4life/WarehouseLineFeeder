<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Warehouse Delivery Request System (Multi-User)</title>

  <!-- React (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- OPTIONAL: Supabase (enable in CONFIG below) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    html, body { 
      margin: 0; 
      padding: 0; 
      width: 100%;
      height: 100%;
      overflow-x: hidden;
      font-family: 'Space Mono','Courier New',monospace;
      /* Prevent text size adjustment on orientation change */
      -webkit-text-size-adjust: 100%;
      -moz-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
      text-size-adjust: 100%;
      /* Prevent pull-to-refresh */
      overscroll-behavior-y: contain;
    }
    body {
      /* Safe area support for notched devices */
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    * { 
      box-sizing: border-box;
      /* Prevent tap highlight on mobile */
      -webkit-tap-highlight-color: transparent;
    }
    a { color: inherit; }
    #root {
      min-height: 100vh;
      width: 100%;
    }
    /* Prevent zoom on input focus */
    input, select, textarea {
      font-size: 16px !important;
    }
  </style>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" type="image/svg+xml" href="./favicon.svg">
  <meta name="theme-color" content="#00ff88">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    /**********************************************************************
     * CONFIG (Multi-user)
     *
     * ‚úÖ Works out of the box using localStorage + BroadcastChannel.
     * ‚úÖ Production multi-user (recommended): enable Supabase below.
     *
     * HOW TO ENABLE SUPABASE:
     * 1) Create a Supabase project
     * 2) Create table + policies (SQL below)
     * 3) Paste your URL + anon key, set ENABLE_SUPABASE=true
     *
     * ---- Supabase SQL (run in SQL Editor) -------------------------------
     * create table if not exists warehouse_requests (
     *   id bigint primary key,
     *   item text not null,
     *   room text not null,
     *   qty int not null default 0,
     *   adj_qty int not null default 0,
     *   priority boolean not null default false,
     *   comments text,
     *   status text not null default 'pending', -- pending|claimed|in_progress|completed|cancelled
     *   submitted_at timestamptz not null default now(),
     *   submitted_by text,
     *   submitted_by_role text,
     *   claimed_by text,
     *   claimed_at timestamptz,
     *   started_at timestamptz,
     *   completed_at timestamptz,
     *   completed_by text,
     *   cancelled_at timestamptz,
     *   cancelled_by text,
     *   version int not null default 1,
     *   last_updated_at timestamptz not null default now()
     * );
     *
     * -- Realtime (Database -> Replication -> enable for warehouse_requests)
     *
     * -- RLS + policies (simple starter; tighten later)
     * alter table warehouse_requests enable row level security;
     * create policy "read all" on warehouse_requests for select using (true);
     * create policy "insert all" on warehouse_requests for insert with check (true);
     * create policy "update all" on warehouse_requests for update using (true);
     * -------------------------------------------------------------------
     **********************************************************************/
    const CONFIG = {
      ENABLE_SUPABASE: false, // <- set true for real multi-user across devices
      SUPABASE_URL: "https://vryxhveadpvhgvhyyary.supabase.co",
      SUPABASE_ANON_KEY: "sb_publishable_vKIZKhITzYfAJqfg-O-Zbw_4UXI1U8e",
      STORAGE_KEY: "warehouse-requests-v3",
      REFRESH_MS: 2500, // polling fallback; realtime will override
      SLA_MINUTES_WARN: 5,
      SLA_MINUTES_BAD: 10,
      SLA_MINUTES_CRIT: 20,
      ROOMS: ["Bistro", "Salad", "Film", "Labels", "Boxes"]
    };

    // Icons (same style as your original file)
    const Icon = ({ children, size=24, color="currentColor" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        {children}
      </svg>
    );
    const Package = (p)=>(
      <Icon {...p}><path d="M16.5 9.4l-9-5.19"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></Icon>
    );
    const MapPin = (p)=>(
      <Icon {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></Icon>
    );
    const Clock = (p)=>(
      <Icon {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>
    );
    const Calendar = (p)=>(
      <Icon {...p}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></Icon>
    );
    const MessageSquare = (p)=>(
      <Icon {...p}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></Icon>
    );
    const AlertCircle = (p)=>(
      <Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></Icon>
    );
    const Truck = (p)=>(
      <Icon {...p}><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></Icon>
    );
    const CheckCircle = (p)=>(
      <Icon {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>
    );
    const XCircle = (p)=>(
      <Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></Icon>
    );
    const Edit2 = (p)=>(
      <Icon {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></Icon>
    );
    const Save = (p)=>(
      <Icon {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>
    );

    // Helpers
    const nowIso = ()=> new Date().toISOString();
    const niceTime = (d)=> new Date(d).toLocaleString('en-US', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
    const msToMins = (ms)=> Math.max(0, Math.floor(ms/60000));
    const safeJsonParse = (s, fallback)=> {
      try {
        if (s === null || s === undefined || s === "") return fallback;
        const v = JSON.parse(s);
        return (v === null || v === undefined) ? fallback : v;
      } catch {
        return fallback;
      }
    };

    // Notifications
    const canNotify = ()=> ('Notification' in window);
    const requestNotifyPermission = async ()=>{
      if (!canNotify()) return false;
      if (Notification.permission === 'granted') return true;
      if (Notification.permission === 'denied') return false;
      const p = await Notification.requestPermission();
      return p === 'granted';
    };

    // Local multi-tab sync channel (works on same device)
    const bc = ("BroadcastChannel" in window) ? new BroadcastChannel("warehouse-req-sync") : null;

    // Data adapter (LocalStorage OR Supabase)
    function createAdapter({ onRemoteChange }) {
      const useSupabase = CONFIG.ENABLE_SUPABASE && CONFIG.SUPABASE_URL && CONFIG.SUPABASE_ANON_KEY && window.supabase;
      const supabaseClient = useSupabase ? window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY) : null;

      let unsub = null;

      const localLoad = async ()=> {
        const raw = localStorage.getItem(CONFIG.STORAGE_KEY);
        const v = safeJsonParse(raw, []);
        return Array.isArray(v) ? v : [];
      };
      const localSave = async (rows)=> {
        localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(rows));
        bc?.postMessage({ type:"updated" });
        return rows;
      };

      const supaNormalize = (r)=> ({
        id: Number(r.id),
        item: r.item,
        room: r.room,
        qty: Number(r.qty||0),
        adjQty: Number(r.adj_qty||0),
        priority: !!r.priority,
        comments: r.comments || "",
        status: r.status,
        submittedAt: r.submitted_at,
        submittedBy: r.submitted_by || "",
        submittedByRole: r.submitted_by_role || "",
        claimedBy: r.claimed_by || null,
        claimedAt: r.claimed_at || null,
        startedAt: r.started_at || null,
        completedAt: r.completed_at || null,
        completedBy: r.completed_by || null,
        cancelledAt: r.cancelled_at || null,
        cancelledBy: r.cancelled_by || null,
        version: Number(r.version || 1),
        lastUpdatedAt: r.last_updated_at || r.submitted_at
      });

      const supaDenormalize = (r)=> ({
        id: Number(r.id),
        item: r.item,
        room: r.room,
        qty: Number(r.qty||0),
        adj_qty: Number(r.adjQty||0),
        priority: !!r.priority,
        comments: r.comments || "",
        status: r.status,
        submitted_at: r.submittedAt || nowIso(),
        submitted_by: r.submittedBy || "",
        submitted_by_role: r.submittedByRole || "",
        claimed_by: r.claimedBy || null,
        claimed_at: r.claimedAt || null,
        started_at: r.startedAt || null,
        completed_at: r.completedAt || null,
        completed_by: r.completedBy || null,
        cancelled_at: r.cancelledAt || null,
        cancelled_by: r.cancelledBy || null,
        version: Number(r.version||1),
        last_updated_at: r.lastUpdatedAt || nowIso()
      });

      const adapter = {
        kind: useSupabase ? "supabase" : "local",
        async init() {
          if (useSupabase) {
            // Realtime subscription
            const channel = supabaseClient.channel("warehouse-delivery-requests")
              .on("postgres_changes", { event:"*", schema:"public", table:"warehouse_requests" }, () => onRemoteChange?.())
              .subscribe();
            unsub = ()=> supabaseClient.removeChannel(channel);
          } else {
            // Same-device multi-tab sync
            bc?.addEventListener("message", (e)=> {
              if (e?.data?.type === "updated") onRemoteChange?.();
            });
            window.addEventListener("storage", (e)=> {
              if (e.key === CONFIG.STORAGE_KEY) onRemoteChange?.();
            });
          }
        },
        destroy() { try { unsub?.(); } catch {} },
        async loadAll() {
          if (!useSupabase) return await localLoad();
          const { data, error } = await supabaseClient
            .from("warehouse_requests")
            .select("*")
            .order("submitted_at", { ascending: true });
          if (error) throw error;
          return (data || []).map(supaNormalize);
        },
        async upsert(row) {
          if (!useSupabase) {
            const rows = await localLoad();
            const idx = rows.findIndex(r => r.id === row.id);
            const next = (idx >= 0) ? rows.map(r => r.id===row.id ? row : r) : [...rows, row];
            return await localSave(next);
          }
          const payload = supaDenormalize(row);
          const { error } = await supabaseClient.from("warehouse_requests").upsert(payload);
          if (error) throw error;
          return true;
        },
        async updatePartial(id, patchFn) {
          if (!useSupabase) {
            const rows = await localLoad();
            const idx = rows.findIndex(r=>r.id===id);
            if (idx < 0) return rows;
            const current = rows[idx];
            const nextRow = patchFn({ ...current });
            const next = rows.map(r=> r.id===id ? nextRow : r);
            return await localSave(next);
          }
          // For Supabase: load current row, then write back with version bump
          const { data, error } = await supabaseClient.from("warehouse_requests").select("*").eq("id", id).maybeSingle();
          if (error) throw error;
          if (!data) return true;
          const current = supaNormalize(data);
          const updated = patchFn({ ...current });
          updated.version = (current.version || 1) + 1;
          updated.lastUpdatedAt = nowIso();
          return await adapter.upsert(updated);
        },
        async clearCompleted() {
          if (!useSupabase) {
            const rows = await localLoad();
            return await localSave(rows.filter(r => r.status !== "completed"));
          }
          const { error } = await supabaseClient.from("warehouse_requests").delete().eq("status", "completed");
          if (error) throw error;
          return true;
        },
        async clearAll() {
          if (!useSupabase) {
            return await localSave([]);
          }
          const { error } = await supabaseClient.from("warehouse_requests").delete().neq("id", -1);
          if (error) throw error;
          return true;
        }
      };
      return adapter;
    }

    function WarehouseDeliveryApp() {
      // Screen routing: login | form | picklist | board | dashboard
      const [screen, setScreen] = useState(() => {
        const hash = (location.hash || "").replace("#","").trim();
        return hash || "login";
      });

      const [userName, setUserName] = useState(localStorage.getItem("wd_userName") || "");
      const [userRole, setUserRole] = useState(localStorage.getItem("wd_userRole") || ""); // room|warehouse|supervisor
      const [tempName, setTempName] = useState(userName);
      const [tempRole, setTempRole] = useState(userRole);

      const [requests, setRequests] = useState([]);
      const [loading, setLoading] = useState(true);
      const [errors, setErrors] = useState({});
      const [successMsg, setSuccessMsg] = useState("");
      const [notificationsEnabled, setNotificationsEnabled] = useState(false);
      const [connectionMode, setConnectionMode] = useState("local"); // "local" or "supabase"

      const [editingId, setEditingId] = useState(null);
      const [editQty, setEditQty] = useState(0);

      const [viewGroup, setViewGroup] = useState("room"); // room|item|status
      const [onlyActive, setOnlyActive] = useState(true);
      const [search, setSearch] = useState("");
      const [sortMode, setSortMode] = useState("priority_age"); // priority_age|age|room|item
      const [timeFilter, setTimeFilter] = useState("today"); // for dashboard analytics
      const [adminTimeFilter, setAdminTimeFilter] = useState("day"); // for admin panel

      // Users & Assignments
      const [users, setUsers] = useState(() => {
        try { return JSON.parse(localStorage.getItem("wd_users_v1") || "[]"); } catch { return []; }
      });
      const [assignments, setAssignments] = useState(() => {
        try { return JSON.parse(localStorage.getItem("wd_assignments_v1") || "[]"); } catch { return []; }
      });
      // User management form state
      const [newUserName, setNewUserName] = useState("");
      const [newUserRole, setNewUserRole] = useState("room");
      const [editUserId, setEditUserId] = useState(null);
      const [editUserName, setEditUserName] = useState("");
      const [editUserRole, setEditUserRole] = useState("");
      // Assignment form state
      const [assignPerson, setAssignPerson] = useState("");
      const [assignRoom, setAssignRoom] = useState("");
      const [assignDuration, setAssignDuration] = useState("day");
      // Login error
      const [loginError, setLoginError] = useState("");

      const saveUsers = (updated) => {
        setUsers(updated);
        localStorage.setItem("wd_users_v1", JSON.stringify(updated));
      };

      const saveAssignments = (updated) => {
        setAssignments(updated);
        localStorage.setItem("wd_assignments_v1", JSON.stringify(updated));
      };

      const genId = () => Math.random().toString(36).substr(2, 9) + Date.now().toString(36);

      const expiryDate = (duration) => {
        const d = new Date();
        if (duration === "day") d.setDate(d.getDate() + 1);
        else if (duration === "week") d.setDate(d.getDate() + 7);
        else if (duration === "month") d.setMonth(d.getMonth() + 1);
        else if (duration === "year") d.setFullYear(d.getFullYear() + 1);
        return d.toISOString();
      };

      // Active assignments (not expired)
      const activeAssignments = assignments.filter(a => new Date(a.expiresAt) > new Date());

      const dropdownRef = useRef(null);

      const rooms = CONFIG.ROOMS;

      const adapterRef = useRef(null);

      // Keep hash in sync (TV board can be loaded via #board)
      useEffect(() => {
        const onHash = () => {
          const h = (location.hash || "").replace("#","").trim();
          if (h) setScreen(h);
        };
        window.addEventListener("hashchange", onHash);
        return () => window.removeEventListener("hashchange", onHash);
      }, []);

      const setRoute = (s)=> {
        setScreen(s);
        location.hash = s;
      };

      const showNotification = (title, body) => {
        if (!notificationsEnabled || !canNotify()) return;
        try {
          new Notification(title, {
            body,
            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">üì¶</text></svg>'
          });
        } catch {}
      };

      const loadAll = async ()=> {
        try {
          const adapter = adapterRef.current;
          if (!adapter) return;
          const data = await adapter.loadAll();
          setRequests(Array.isArray(data) ? data : []);
          setLoading(false);
        } catch (error) {
          console.error("Failed to load data:", error);
          setLoading(false);
        }
      };

      useEffect(() => {
        (async ()=>{
          try {
            setNotificationsEnabled(await requestNotifyPermission());
            const adapter = createAdapter({ onRemoteChange: loadAll });
            adapterRef.current = adapter;
            setConnectionMode(adapter.kind); // Update connection mode state
            await adapter.init();
            await loadAll();

            // polling fallback (supabase realtime already calls onRemoteChange)
            const t = setInterval(() => loadAll().catch(console.error), CONFIG.REFRESH_MS);
            return () => { clearInterval(t); adapter.destroy(); };
          } catch (error) {
            console.error("Failed to initialize app:", error);
            setLoading(false);
          }
        })();
        // eslint-disable-next-line react-hooks/exhaustive-deps
      }, []);

      // Store user identity
      useEffect(() => {
        localStorage.setItem("wd_userName", userName || "");
        localStorage.setItem("wd_userRole", userRole || "");
      }, [userName, userRole]);

      // Derived: filtered + sorted list
      const visibleRequests = useMemo(() => {
        const q = search.trim().toLowerCase();
        let rows = [...requests];

        if (onlyActive) rows = rows.filter(r => r.status !== "completed" && r.status !== "cancelled");
        if (q) {
          rows = rows.filter(r =>
            (r.item||"").toLowerCase().includes(q) ||
            (r.room||"").toLowerCase().includes(q) ||
            (r.submittedBy||"").toLowerCase().includes(q) ||
            (r.claimedBy||"").toLowerCase().includes(q)
          );
        }

        const ageMs = (r)=> Date.now() - new Date(r.submittedAt || r.submitted_at || Date.now()).getTime();
        const priorityScore = (r)=> r.priority ? -1 : 0;

        rows.sort((a,b) => {
          if (sortMode === "priority_age") {
            const pa = priorityScore(a) - priorityScore(b);
            if (pa !== 0) return pa;
            return ageMs(b) - ageMs(a); // older first => bigger age
          }
          if (sortMode === "age") return ageMs(b) - ageMs(a);
          if (sortMode === "room") return (a.room||"").localeCompare(b.room||"") || (ageMs(b) - ageMs(a));
          if (sortMode === "item") return (a.item||"").localeCompare(b.item||"") || (ageMs(b) - ageMs(a));
          return 0;
        });

        return rows;
      }, [requests, onlyActive, search, sortMode]);

      // Grouping
      const grouped = useMemo(() => {
        const g = {};
        const keyFn = (r)=> {
          if (viewGroup === "item") return r.item || "Unknown Item";
          if (viewGroup === "status") return r.status || "unknown";
          return r.room || "Unknown Room";
        };
        visibleRequests.forEach(r => {
          const k = keyFn(r);
          if (!g[k]) g[k] = [];
          g[k].push(r);
        });
        const keys = Object.keys(g);
        keys.sort((a,b)=> a.localeCompare(b));
        return { keys, map: g };
      }, [visibleRequests, viewGroup]);

      // Metrics
      const metrics = useMemo(() => {
        const total = requests.length;
        const pending = requests.filter(r => r.status === "pending").length;
        const claimed = requests.filter(r => r.status === "claimed").length;
        const inprog = requests.filter(r => r.status === "in_progress").length;
        const completed = requests.filter(r => r.status === "completed").length;
        const cancelled = requests.filter(r => r.status === "cancelled").length;
        return { total, pending, claimed, inprog, completed, cancelled };
      }, [requests]);

      const canWarehouseAct = userRole === "warehouse" || userRole === "supervisor" || userRole === "admin";
      const canSupervisor = userRole === "supervisor" || userRole === "admin";
      const canAdmin = userRole === "admin";

      const slaBadge = (req)=> {
        const submittedAt = req.submittedAt || req.submitted_at || nowIso();
        const mins = msToMins(Date.now() - new Date(submittedAt).getTime());
        let bg = "#1e293b", fg="#8b9dc3", label=`${mins}m`;
        if (mins >= CONFIG.SLA_MINUTES_CRIT) { bg="#ff4444"; fg="#fff"; label=`${mins}m üî•`; }
        else if (mins >= CONFIG.SLA_MINUTES_BAD) { bg="#fbbf24"; fg="#0a0e1a"; label=`${mins}m`; }
        else if (mins >= CONFIG.SLA_MINUTES_WARN) { bg="#22c55e"; fg="#0a0e1a"; label=`${mins}m`; }
        return { bg, fg, label };
      };

      const validateForm = (formData) => {
        const e = {};
        if (!formData.item.trim()) e.item = "Item is required";
        if (!formData.room) e.room = "Room is required";
        if (!Number.isFinite(formData.qty) || formData.qty <= 0) e.qty = "Qty must be > 0";
        setErrors(e);
        return Object.keys(e).length === 0;
      };

      const defaultForm = () => {
        const timeString = new Date().toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true });
        return {
          item: "",
          room: "",
          qty: 1,
          adjQty: 0,
          reqTime: timeString,
          delTime: "",
          priority: false,
          comments: ""
        };
      };

      const [formData, setFormData] = useState(defaultForm());
      const [roomDropdownOpen, setRoomDropdownOpen] = useState(false);
      const [roomSearch, setRoomSearch] = useState("");

      useEffect(() => {
        function handleClickOutside(event) {
          if (dropdownRef.current && !dropdownRef.current.contains(event.target)) setRoomDropdownOpen(false);
        }
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
      }, []);

      const filteredRooms = useMemo(() => rooms.filter(r => r.toLowerCase().includes(roomSearch.toLowerCase())), [rooms, roomSearch]);

      const submitRequest = async (e)=> {
        e.preventDefault();
        if (!validateForm(formData)) return;

        try {
          const id = Date.now(); // ok for MVP; Supabase primary key expects bigint
          const req = {
            id,
            item: formData.item.trim(),
            room: formData.room,
            qty: Number(formData.qty) || 0,
            adjQty: Number(formData.adjQty) || 0,
            priority: !!formData.priority,
            comments: (formData.comments || "").trim(),
            status: "pending",
            submittedAt: nowIso(),
            submittedBy: userName,
            submittedByRole: userRole,
            claimedBy: null,
            claimedAt: null,
            startedAt: null,
            completedAt: null,
            completedBy: null,
            cancelledAt: null,
            cancelledBy: null,
            version: 1,
            lastUpdatedAt: nowIso()
          };

          await adapterRef.current.upsert(req);
          await loadAll();

          // Notify warehouse users (best-effort ‚Äî will show on their devices if enabled)
          showNotification("üì¶ Request Submitted", `${req.submittedBy} requested ${req.qty} ${req.item} for ${req.room}${req.priority ? " (HIGH)" : ""}`);

          setSuccessMsg(`‚úÖ Submitted: ${req.qty} ${req.item} ‚Üí ${req.room}`);
          setTimeout(() => setSuccessMsg(""), 2500);

          setFormData(defaultForm());
          setTimeout(() => setRoute("picklist"), 150);
        } catch (error) {
          console.error("Failed to submit request:", error);
          setSuccessMsg(`‚ùå Error: Failed to submit request`);
          setTimeout(() => setSuccessMsg(""), 3000);
        }
      };

      // Actions (multi-user safe pattern: updatePartial)
      const claimRequest = async (id)=> {
        if (!canWarehouseAct) return;
        try {
          await adapterRef.current.updatePartial(id, (r)=> {
            // If already claimed by someone else, do nothing
            if (r.status !== "pending") return r;
            r.status = "claimed";
            r.claimedBy = userName;
            r.claimedAt = nowIso();
            r.lastUpdatedAt = nowIso();
            return r;
          });
          await loadAll();
        } catch (error) {
          console.error("Failed to claim request:", error);
        }
      };

      const startRequest = async (id)=> {
        if (!canWarehouseAct) return;
        try {
          await adapterRef.current.updatePartial(id, (r)=> {
            if (r.status === "completed" || r.status === "cancelled") return r;
            // Only claimant (or supervisor) can start
            if (r.claimedBy && r.claimedBy !== userName && !canSupervisor) return r;
            if (!r.claimedBy) { r.claimedBy = userName; r.claimedAt = nowIso(); }
            r.status = "in_progress";
            r.startedAt = r.startedAt || nowIso();
            r.lastUpdatedAt = nowIso();
            return r;
          });
          await loadAll();
        } catch (error) {
          console.error("Failed to start request:", error);
        }
      };

      const completeRequest = async (id)=> {
        if (!canWarehouseAct) return;
        try {
          let completedRow = null;
          await adapterRef.current.updatePartial(id, (r)=> {
            if (r.status === "completed" || r.status === "cancelled") return r;
            if (r.claimedBy && r.claimedBy !== userName && !canSupervisor) return r;
            r.status = "completed";
            r.completedAt = nowIso();
            r.completedBy = userName;
            r.lastUpdatedAt = nowIso();
            completedRow = r;
            return r;
          });
          await loadAll();
          if (completedRow) showNotification("‚úÖ Completed", `${completedRow.item} delivered to ${completedRow.room} by ${userName}`);
        } catch (error) {
          console.error("Failed to complete request:", error);
        }
      };

      const cancelRequest = async (id)=> {
        if (!canWarehouseAct) return;
        try {
          await adapterRef.current.updatePartial(id, (r)=> {
            if (r.status === "completed") return r;
            if (r.claimedBy && r.claimedBy !== userName && !canSupervisor) return r;
            r.status = "cancelled";
            r.cancelledAt = nowIso();
            r.cancelledBy = userName;
            r.lastUpdatedAt = nowIso();
            return r;
          });
          await loadAll();
        } catch (error) {
          console.error("Failed to cancel request:", error);
        }
      };

      const adjustQty = async (id, newQty)=> {
        if (!canWarehouseAct) return;
        try {
          await adapterRef.current.updatePartial(id, (r)=> {
            if (r.status === "completed" || r.status === "cancelled") return r;
            if (r.claimedBy && r.claimedBy !== userName && !canSupervisor) return r;
            r.adjQty = Number(newQty) || 0;
            r.lastUpdatedAt = nowIso();
            return r;
          });
          setEditingId(null);
          await loadAll();
        } catch (error) {
          console.error("Failed to adjust quantity:", error);
          setEditingId(null);
        }
      };

      const clearCompleted = async ()=> {
        if (!canSupervisor) return;
        if (!confirm("Clear all completed requests? This cannot be undone.")) return;
        try {
          await adapterRef.current.clearCompleted();
          await loadAll();
        } catch (error) {
          console.error("Failed to clear completed requests:", error);
        }
      };

      const clearAll = async ()=> {
        if (!canSupervisor) return;
        if (!confirm("DANGER: Clear ALL requests? This cannot be undone.")) return;
        try {
          await adapterRef.current.clearAll();
          await loadAll();
        } catch (error) {
          console.error("Failed to clear all requests:", error);
        }
      };

      const deleteRequest = async (id) => {
        if (!canAdmin) return;
        if (!confirm("Delete this request permanently? This cannot be undone.")) return;
        try {
          const adapter = adapterRef.current;
          if (adapter.kind === "supabase") {
            const { error } = await adapter.client.from('warehouse_requests').delete().eq('id', id);
            if (error) throw error;
          } else {
            localStorage.setItem(CONFIG.LOCAL_STORAGE_KEY, JSON.stringify(requests.filter(r => r.id !== id)));
          }
          await loadAll();
          setSuccessMsg("Request deleted!");
          setTimeout(() => setSuccessMsg(""), 3000);
        } catch (error) {
          console.error("Failed to delete:", error);
          alert("Failed to delete request");
        }
      };

      // UI theme bits
      const bg = { background:'linear-gradient(135deg, #0a0e1a 0%, #1a1f2e 100%)' };
      const gridOverlay = {
        position:'absolute', top:0, left:0, right:0, bottom:0,
        backgroundImage: `
          repeating-linear-gradient(0deg, rgba(0, 255, 136, 0.03) 0px, transparent 1px, transparent 2px, rgba(0, 255, 136, 0.03) 3px),
          repeating-linear-gradient(90deg, rgba(0, 255, 136, 0.03) 0px, transparent 1px, transparent 2px, rgba(0, 255, 136, 0.03) 3px)
        `,
        backgroundSize:'40px 40px',
        opacity:0.4,
        pointerEvents:'none'
      };

      const headerStyle = {
        padding: '0.85rem',
        textAlign: 'left',
        color: '#8b9dc3',
        fontSize: '0.72rem',
        fontWeight: 700,
        textTransform: 'uppercase',
        letterSpacing: '0.05em',
        borderBottom: '2px solid #334155',
        whiteSpace: 'nowrap'
      };
      const cellStyle = {
        padding: '0.85rem',
        color: '#e2e8f0',
        fontSize: '0.9rem',
        verticalAlign: 'top'
      };

      // LOGIN
      if (screen === "login") {
        const noUsers = users.length === 0;
        const matchedUser = users.find(u => u.name.toLowerCase().trim() === tempName.toLowerCase().trim());

        const handleSignIn = () => {
          setLoginError("");
          const name = tempName.trim();
          if (!name) { setLoginError("Please enter your name."); return; }

          // First-time setup: no users exist yet
          if (noUsers) {
            if (!tempRole) { setLoginError("Select a role."); return; }
            // Bootstrap first admin
            const firstAdmin = { id: genId(), name, role: tempRole, createdAt: new Date().toISOString(), createdBy: "system" };
            saveUsers([firstAdmin]);
            setUserName(name); setUserRole(tempRole);
            localStorage.setItem("wd_userName", name);
            localStorage.setItem("wd_userRole", tempRole);
            if (tempRole === "admin") setRoute("admin");
            else if (tempRole === "room") setRoute("form");
            else setRoute("picklist");
            return;
          }

          // Normal login: must be in users list
          if (!matchedUser) {
            setLoginError("You are not registered. Please contact your Admin to be added.");
            return;
          }

          setUserName(matchedUser.name);
          setUserRole(matchedUser.role);
          localStorage.setItem("wd_userName", matchedUser.name);
          localStorage.setItem("wd_userRole", matchedUser.role);
          if (matchedUser.role === "admin") setRoute("admin");
          else if (matchedUser.role === "room") setRoute("form");
          else setRoute("picklist");
        };

        return (
          <div style={{ minHeight:'100vh', ...bg, padding:'2rem', position:'relative', overflow:'hidden', display:'flex', alignItems:'center', justifyContent:'center' }}>
            <div style={gridOverlay} />
            <div style={{
              maxWidth:'520px', width:'100%',
              background:'rgba(15, 23, 42, 0.8)', backdropFilter:'blur(10px)',
              border:'1px solid rgba(0, 255, 136, 0.2)', borderRadius:'12px',
              padding:'3rem', boxShadow:'0 8px 32px rgba(0,0,0,0.3)', position:'relative', zIndex:1
            }}>
              <div style={{ textAlign:'center', marginBottom:'2rem' }}>
                <div style={{ display:'inline-flex', alignItems:'center', gap:'1rem', marginBottom:'1rem', padding:'0.75rem 1.5rem', background:'rgba(0,255,136,0.1)', border:'2px solid #00ff88', borderRadius:'8px', boxShadow:'0 0 20px rgba(0,255,136,0.3)' }}>
                  <Package size={32} color="#00ff88" />
                  <h1 style={{ margin:0, fontSize:'1.6rem', fontWeight:800, color:'#00ff88', textTransform:'uppercase', letterSpacing:'0.1em' }}>
                    Warehouse System
                  </h1>
                </div>
                <p style={{ color:'#8b9dc3', margin:0, fontSize:'0.9rem', letterSpacing:'0.04em' }}>
                  {noUsers ? "‚öôÔ∏è First Time Setup ‚Äî Create Admin Account" : "Sign in to continue"}
                </p>
              </div>

              {noUsers && (
                <div style={{ marginBottom:'1.5rem', padding:'1rem', background:'rgba(251,191,36,0.1)', border:'1px solid #fbbf24', borderRadius:'8px', color:'#fbbf24', fontSize:'0.85rem' }}>
                  ‚ö†Ô∏è No users exist yet. Create the first account below. This person will be able to manage all other users.
                </div>
              )}

              <label style={{ display:'block', color:'#e2e8f0', fontSize:'0.85rem', fontWeight:700, marginBottom:'0.5rem', textTransform:'uppercase', letterSpacing:'0.05em' }}>
                Your Name <span style={{ color:'#00ff88' }}>*</span>
              </label>
              <input
                value={tempName}
                onChange={(e) => { setTempName(e.target.value); setLoginError(""); }}
                onKeyDown={(e) => e.key === "Enter" && handleSignIn()}
                placeholder="Enter your name"
                style={{ width:'100%', padding:'0.875rem', background:'#1e293b', border:'2px solid #334155', borderRadius:'6px', color:'#e2e8f0', fontSize:'1rem', outline:'none' }}
              />

              {/* Show matched user's role (if found) */}
              {!noUsers && matchedUser && (
                <div style={{ marginTop:'0.75rem', padding:'0.75rem 1rem', background:'rgba(0,255,136,0.1)', border:'1px solid rgba(0,255,136,0.3)', borderRadius:'8px', color:'#00ff88', fontSize:'0.9rem', fontWeight:700 }}>
                  ‚úÖ Found: {matchedUser.name} ¬∑ Role: <span style={{ textTransform:'uppercase' }}>{matchedUser.role}</span>
                </div>
              )}

              {/* First-time setup: show role selector */}
              {noUsers && (
                <>
                  <div style={{ height:'1rem' }} />
                  <label style={{ display:'block', color:'#e2e8f0', fontSize:'0.85rem', fontWeight:700, marginBottom:'0.5rem', textTransform:'uppercase', letterSpacing:'0.05em' }}>
                    Role <span style={{ color:'#00ff88' }}>*</span>
                  </label>
                  <div style={{ display:'grid', gridTemplateColumns:'1fr 1fr', gap:'0.75rem', marginBottom:'1rem' }}>
                    {[
                      { key:"admin", label:"üîß Admin" },
                      { key:"supervisor", label:"üß≠ Supervisor" },
                      { key:"warehouse", label:"üì¶ Warehouse" },
                      { key:"room", label:"üçΩÔ∏è Room" }
                    ].map(r => (
                      <button key={r.key} type="button" onClick={() => setTempRole(r.key)}
                        style={{
                          padding:'1rem', borderRadius:'8px', cursor:'pointer', fontWeight:800,
                          border: tempRole===r.key ? '2px solid #00ff88' : '2px solid #334155',
                          background: tempRole===r.key ? 'linear-gradient(135deg, #00ff88 0%, #00cc6f 100%)' : '#1e293b',
                          color: tempRole===r.key ? '#0a0e1a' : '#e2e8f0',
                          textTransform:'uppercase', letterSpacing:'0.04em'
                        }}>
                        {r.label}
                      </button>
                    ))}
                  </div>
                </>
              )}

              {loginError && (
                <div style={{ marginTop:'0.75rem', padding:'0.75rem 1rem', background:'rgba(255,68,68,0.1)', border:'1px solid #ff4444', borderRadius:'8px', color:'#ff4444', fontSize:'0.85rem', fontWeight:700 }}>
                  ‚ùå {loginError}
                </div>
              )}

              <div style={{ height:'1.25rem' }} />

              <button onClick={handleSignIn}
                style={{ width:'100%', padding:'1.1rem', background:'linear-gradient(135deg, #00ff88 0%, #00cc6f 100%)', border:'none', borderRadius:'10px', color:'#0a0e1a', fontSize:'1.05rem', fontWeight:900, cursor:'pointer', textTransform:'uppercase', letterSpacing:'0.08em', boxShadow:'0 4px 16px rgba(0,255,136,0.35)' }}>
                {noUsers ? "Create Account & Sign In" : "Sign In"}
              </button>

              <div style={{ marginTop:'1rem', padding:'0.75rem', background:'rgba(0,255,136,0.08)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'8px', color:'#00ff88', fontSize:'0.8rem', textAlign:'center' }}>
                üîî Notifications: {notificationsEnabled ? "Enabled" : "Not enabled"}
              </div>

              {!noUsers && (
                <div style={{ marginTop:'1rem', color:'#64748b', fontSize:'0.75rem', textAlign:'center' }}>
                  Not registered? Contact your Admin to be added to the system.
                </div>
              )}
            </div>
          </div>
        );
      }

      // HEADER BAR (shared)
      const TopBar = ({ title, subtitle }) => (
        <div style={{
          marginBottom:'1.25rem',
          display:'flex',
          justifyContent:'space-between',
          alignItems:'center',
          flexWrap:'wrap',
          gap:'0.75rem'
        }}>
          <div style={{ display:'flex', alignItems:'center', gap:'0.85rem' }}>
            <div style={{ display:'inline-flex', alignItems:'center', gap:'0.85rem', padding:'0.7rem 1.25rem', background:'rgba(0,255,136,0.1)', border:'2px solid #00ff88', borderRadius:'10px', boxShadow:'0 0 18px rgba(0,255,136,0.25)' }}>
              <Truck size={28} color="#00ff88" />
              <div>
                <div style={{ margin:0, fontSize:'1.4rem', fontWeight:900, color:'#00ff88', textTransform:'uppercase', letterSpacing:'0.09em' }}>
                  {title}
                </div>
                <div style={{ margin:0, fontSize:'0.75rem', color:'#8b9dc3', letterSpacing:'0.04em' }}>
                  {subtitle}
                </div>
              </div>
            </div>

            <div style={{ display:'flex', gap:'0.8rem', padding:'0.65rem 0.9rem', background:'rgba(15,23,42,0.8)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'10px' }}>
              {[
                { label:"Pending", val: metrics.pending, color:"#fbbf24" },
                { label:"Claimed", val: metrics.claimed, color:"#38bdf8" },
                { label:"In Prog", val: metrics.inprog, color:"#a78bfa" },
                { label:"Done", val: metrics.completed, color:"#00ff88" }
              ].map(m => (
                <div key={m.label} style={{ textAlign:'center' }}>
                  <div style={{ fontSize:'1.2rem', fontWeight:900, color:m.color }}>{m.val}</div>
                  <div style={{ fontSize:'0.65rem', color:'#8b9dc3', textTransform:'uppercase' }}>{m.label}</div>
                </div>
              ))}
            </div>
          </div>

          <div style={{ display:'flex', gap:'0.6rem', flexWrap:'wrap', alignItems:'center' }}>
            <button onClick={()=> setRoute("form")}
              style={{ padding:'0.7rem 1.1rem', background:'linear-gradient(135deg, #00ff88 0%, #00cc6f 100%)', border:'none', borderRadius:'10px', color:'#0a0e1a', fontWeight:900, cursor:'pointer', textTransform:'uppercase', letterSpacing:'0.04em' }}>
              + New
            </button>

            <button onClick={()=> setRoute("picklist")}
              style={{ padding:'0.7rem 1.1rem', background:'transparent', border:'1px solid rgba(0,255,136,0.4)', borderRadius:'10px', color:'#00ff88', fontWeight:800, cursor:'pointer', textTransform:'uppercase', letterSpacing:'0.04em' }}>
              Pick List
            </button>

            <button onClick={()=> setRoute("board")}
              style={{ padding:'0.7rem 1.1rem', background:'transparent', border:'1px solid rgba(0,255,136,0.25)', borderRadius:'10px', color:'#8b9dc3', fontWeight:800, cursor:'pointer', textTransform:'uppercase', letterSpacing:'0.04em' }}>
              Board
            </button>

            <button onClick={()=> setRoute("dashboard")}
              style={{ padding:'0.7rem 1.1rem', background:'transparent', border:'1px solid rgba(0,255,136,0.25)', borderRadius:'10px', color: canSupervisor ? '#00ff88' : '#64748b', fontWeight:800, cursor:'pointer', textTransform:'uppercase', letterSpacing:'0.04em' }}>
              Dashboard
            </button>

            <button onClick={()=> setRoute("completed")}
              style={{ padding:'0.7rem 1.1rem', background:'transparent', border:'1px solid rgba(0,255,136,0.25)', borderRadius:'10px', color: canWarehouseAct ? '#00ff88' : '#64748b', fontWeight:800, cursor:'pointer', textTransform:'uppercase', letterSpacing:'0.04em' }}>
              Completed
            </button>

            {canSupervisor && (
              <button onClick={()=> setRoute("assignments")}
                style={{ padding:'0.7rem 1.1rem', background:'transparent', border:'1px solid rgba(56,189,248,0.35)', borderRadius:'10px', color:'#38bdf8', fontWeight:800, cursor:'pointer', textTransform:'uppercase', letterSpacing:'0.04em' }}>
                Assignments
              </button>
            )}

            <button onClick={()=> setRoute("admin")}
              style={{ padding:'0.7rem 1.1rem', background:'transparent', border:'1px solid rgba(255,68,68,0.25)', borderRadius:'10px', color: canAdmin ? '#ff4444' : '#64748b', fontWeight:800, cursor:'pointer', textTransform:'uppercase', letterSpacing:'0.04em' }}>
              Admin
            </button>

            <button onClick={()=>{
              setUserName(""); setUserRole(""); setTempName(""); setTempRole("");
              setRoute("login");
            }}
              style={{ padding:'0.7rem 1.1rem', background:'transparent', border:'1px solid #64748b', borderRadius:'10px', color:'#64748b', fontWeight:800, cursor:'pointer', textTransform:'uppercase', letterSpacing:'0.04em' }}>
              Sign Out
            </button>
          </div>
        </div>
      );

      if (loading) {
        return (
          <div style={{ minHeight:'100vh', ...bg, display:'flex', alignItems:'center', justifyContent:'center', flexDirection:'column', gap:'1rem' }}>
            <div style={{ width:'60px', height:'60px', border:'4px solid #334155', borderTop:'4px solid #00ff88', borderRadius:'50%', animation:'spin 1s linear infinite' }} />
            <p style={{ color:'#00ff88', fontSize:'1rem', fontWeight:800, letterSpacing:'0.1em' }}>LOADING‚Ä¶</p>
            <style>{`@keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }`}</style>
          </div>
        );
      }

      // BOARD (TV / Read-only)
      if (screen === "board") {
        return (
          <div style={{ minHeight:'100vh', ...bg, padding:'1.25rem', position:'relative', overflow:'hidden' }}>
            <div style={gridOverlay} />
            <div style={{ maxWidth:'1600px', margin:'0 auto', position:'relative', zIndex:1 }}>
              <TopBar title="Live Board" subtitle={`üë§ ${userName} (${userRole}) ‚Ä¢ ${connectionMode === "supabase" ? "Supabase ready ‚Ä¢ Realtime" : "Local + kiosk mode"}`} />

              <div style={{ display:'flex', gap:'0.75rem', flexWrap:'wrap', alignItems:'center', marginBottom:'0.75rem' }}>
                <div style={{ color:'#00ff88', fontWeight:900, fontSize:'0.8rem' }}>AUTO-UPDATING</div>
                <div style={{ color:'#64748b', fontSize:'0.75rem' }}>Group:</div>
                <select value={viewGroup} onChange={(e)=> setViewGroup(e.target.value)}
                  style={{ background:'#1e293b', border:'1px solid #334155', color:'#e2e8f0', padding:'0.45rem 0.6rem', borderRadius:'8px' }}>
                  <option value="room">Room</option>
                  <option value="item">Item</option>
                  <option value="status">Status</option>
                </select>

                <label style={{ display:'flex', alignItems:'center', gap:'0.4rem', color:'#8b9dc3', fontSize:'0.8rem' }}>
                  <input type="checkbox" checked={onlyActive} onChange={(e)=> setOnlyActive(e.target.checked)} />
                  Active only
                </label>

                <input value={search} onChange={(e)=> setSearch(e.target.value)} placeholder="Search item / room / person‚Ä¶"
                  style={{ flex:'1 1 280px', background:'#1e293b', border:'1px solid #334155', color:'#e2e8f0', padding:'0.6rem 0.7rem', borderRadius:'10px' }} />

                <select value={sortMode} onChange={(e)=> setSortMode(e.target.value)}
                  style={{ background:'#1e293b', border:'1px solid #334155', color:'#e2e8f0', padding:'0.45rem 0.6rem', borderRadius:'8px' }}>
                  <option value="priority_age">Priority + Age</option>
                  <option value="age">Age</option>
                  <option value="room">Room</option>
                  <option value="item">Item</option>
                </select>
              </div>

              {grouped.keys.length === 0 ? (
                <div style={{ padding:'3rem', textAlign:'center', background:'rgba(15,23,42,0.8)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'12px' }}>
                  <Package size={60} color="#334155" />
                  <div style={{ color:'#64748b', fontWeight:800, marginTop:'1rem' }}>No requests</div>
                </div>
              ) : (
                <div style={{ display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(360px, 1fr))', gap:'1rem' }}>
                  {grouped.keys.map(k => (
                    <div key={k} style={{ background:'rgba(15,23,42,0.8)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'14px', overflow:'hidden' }}>
                      <div style={{ padding:'0.9rem 1rem', background:'linear-gradient(135deg, rgba(0,255,136,0.15) 0%, rgba(0,255,136,0.04) 100%)', borderBottom:'2px solid #00ff88', display:'flex', alignItems:'center', gap:'0.6rem' }}>
                        <MapPin size={18} color="#00ff88" />
                        <div style={{ color:'#00ff88', fontWeight:900, textTransform:'uppercase', letterSpacing:'0.08em' }}>{k}</div>
                        <div style={{ marginLeft:'auto', color:'#8b9dc3', fontSize:'0.8rem' }}>{grouped.map[k].length}</div>
                      </div>
                      <div style={{ padding:'0.75rem' }}>
                        {grouped.map[k].slice(0, 10).map(req => {
                          const sla = slaBadge(req);
                          const statusColor =
                            req.status==="pending" ? "#fbbf24" :
                            req.status==="claimed" ? "#38bdf8" :
                            req.status==="in_progress" ? "#a78bfa" :
                            req.status==="completed" ? "#00ff88" :
                            "#ff4444";
                          return (
                            <div key={req.id} style={{ padding:'0.7rem', border:'1px solid #334155', borderRadius:'12px', marginBottom:'0.6rem' }}>
                              <div style={{ display:'flex', gap:'0.6rem', alignItems:'center' }}>
                                <div style={{ fontWeight:900, color:'#e2e8f0', overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap' }}>
                                  {req.qty}√ó {req.item}
                                </div>
                                {req.priority && <span style={{ marginLeft:'auto', padding:'0.2rem 0.5rem', background:'#ff4444', borderRadius:'8px', color:'#fff', fontWeight:900, fontSize:'0.72rem' }}>HIGH</span>}
                              </div>
                              <div style={{ display:'flex', gap:'0.5rem', alignItems:'center', marginTop:'0.4rem', flexWrap:'wrap' }}>
                                <span style={{ padding:'0.2rem 0.5rem', borderRadius:'8px', background: statusColor, color: req.status==="pending" ? "#0a0e1a" : "#0a0e1a", fontWeight:900, fontSize:'0.72rem', textTransform:'uppercase' }}>
                                  {req.status.replace("_"," ")}
                                </span>
                                <span style={{ padding:'0.2rem 0.5rem', borderRadius:'8px', background:sla.bg, color:sla.fg, fontWeight:900, fontSize:'0.72rem' }}>
                                  {sla.label}
                                </span>
                                <span style={{ color:'#8b9dc3', fontSize:'0.75rem' }}>
                                  by {req.submittedBy || "?"}
                                </span>
                                {req.claimedBy && (
                                  <span style={{ color:'#38bdf8', fontSize:'0.75rem' }}>
                                    claimed: {req.claimedBy}
                                  </span>
                                )}
                              </div>
                              {req.comments && (
                                <div style={{ marginTop:'0.4rem', color:'#8b9dc3', fontSize:'0.78rem', whiteSpace:'nowrap', overflow:'hidden', textOverflow:'ellipsis' }}>
                                  üí¨ {req.comments}
                                </div>
                              )}
                            </div>
                          );
                        })}
                        {grouped.map[k].length > 10 && (
                          <div style={{ color:'#64748b', fontSize:'0.75rem' }}>+ {grouped.map[k].length - 10} more‚Ä¶</div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        );
      }

      // DASHBOARD (Analytics + Supervisor tools)
      if (screen === "dashboard") {
        // Filter requests by time
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const thisWeek = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        
        const filteredReqs = requests.filter(r => {
          const submitted = new Date(r.submittedAt);
          if (timeFilter === "today") return submitted >= today;
          if (timeFilter === "week") return submitted >= thisWeek;
          if (timeFilter === "month") return submitted >= thisMonth;
          return true; // all
        });

        // Calculate stats
        const total = filteredReqs.length;
        const completed = filteredReqs.filter(r => r.status === "completed").length;
        const pending = filteredReqs.filter(r => r.status === "pending").length;
        const claimed = filteredReqs.filter(r => r.status === "claimed").length;
        const inProgress = filteredReqs.filter(r => r.status === "in_progress").length;
        const highPriority = filteredReqs.filter(r => r.priority).length;
        const active = pending + claimed + inProgress;
        
        // Completion rate
        const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
        
        // Average completion time (in minutes)
        const completedReqs = filteredReqs.filter(r => r.status === "completed" && r.submittedAt && r.completedAt);
        const avgCompletionTime = completedReqs.length > 0 
          ? Math.round(completedReqs.reduce((sum, r) => {
              const start = new Date(r.submittedAt);
              const end = new Date(r.completedAt);
              return sum + (end - start) / 60000; // minutes
            }, 0) / completedReqs.length)
          : 0;
        
        // SLA compliance (under 10 minutes)
        const slaCompliant = completedReqs.filter(r => {
          const start = new Date(r.submittedAt);
          const end = new Date(r.completedAt);
          return (end - start) / 60000 <= CONFIG.SLA_MINUTES_WARN;
        }).length;
        const slaRate = completedReqs.length > 0 ? Math.round((slaCompliant / completedReqs.length) * 100) : 0;
        
        // Requests by room
        const byRoom = {};
        filteredReqs.forEach(r => {
          byRoom[r.room] = (byRoom[r.room] || 0) + 1;
        });
        const topRooms = Object.entries(byRoom).sort((a, b) => b[1] - a[1]).slice(0, 5);
        const maxRoomCount = topRooms.length > 0 ? topRooms[0][1] : 1;
        
        // Staff performance (completed requests)
        const byStaff = {};
        completedReqs.forEach(r => {
          const staff = r.completedBy || r.claimedBy || "Unknown";
          if (!byStaff[staff]) byStaff[staff] = { count: 0, totalTime: 0 };
          byStaff[staff].count++;
          const start = new Date(r.submittedAt);
          const end = new Date(r.completedAt);
          byStaff[staff].totalTime += (end - start) / 60000;
        });
        const topStaff = Object.entries(byStaff)
          .map(([name, data]) => ({
            name,
            count: data.count,
            avgTime: Math.round(data.totalTime / data.count)
          }))
          .sort((a, b) => b.count - a.count)
          .slice(0, 5);
        
        // Requests by status for chart
        const statusData = [
          { label: "Completed", count: completed, color: "#00ff88" },
          { label: "In Progress", count: inProgress, color: "#a78bfa" },
          { label: "Claimed", count: claimed, color: "#38bdf8" },
          { label: "Pending", count: pending, color: "#fbbf24" }
        ].filter(s => s.count > 0);
        const maxStatusCount = Math.max(...statusData.map(s => s.count), 1);

        return (
          <div style={{ minHeight:'100vh', ...bg, padding:'1.5rem', position:'relative', overflow:'hidden' }}>
            <div style={gridOverlay} />
            <div style={{ maxWidth:'1400px', margin:'0 auto', position:'relative', zIndex:1 }}>
              <TopBar title="Analytics Dashboard" subtitle={`üë§ ${userName} (${userRole}) ‚Ä¢ ${connectionMode === "supabase" ? "Supabase ready" : "Local + kiosk mode"}`} />

              {/* Time Filter */}
              <div style={{ marginBottom:'1.5rem', display:'flex', gap:'0.75rem', flexWrap:'wrap' }}>
                {["today", "week", "month", "all"].map(filter => (
                  <button key={filter} onClick={() => setTimeFilter(filter)}
                    style={{
                      padding:'0.6rem 1.2rem', borderRadius:'10px',
                      background: timeFilter === filter ? 'linear-gradient(135deg, #00ff88 0%, #00cc6f 100%)' : 'rgba(15,23,42,0.85)',
                      border: timeFilter === filter ? 'none' : '1px solid #334155',
                      color: timeFilter === filter ? '#0a0e1a' : '#8b9dc3',
                      fontWeight:900, cursor:'pointer', textTransform:'uppercase', fontSize:'0.8rem'
                    }}>
                    {filter === "all" ? "All Time" : filter === "week" ? "This Week" : filter === "month" ? "This Month" : "Today"}
                  </button>
                ))}
              </div>

              {/* Stats Cards */}
              <div style={{ display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))', gap:'1rem', marginBottom:'1.5rem' }}>
                <div style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'14px', padding:'1.5rem' }}>
                  <div style={{ color:'#8b9dc3', fontSize:'0.8rem', textTransform:'uppercase', letterSpacing:'0.05em' }}>Total Requests</div>
                  <div style={{ color:'#00ff88', fontSize:'2.5rem', fontWeight:900, marginTop:'0.5rem' }}>{total}</div>
                </div>
                
                <div style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'14px', padding:'1.5rem' }}>
                  <div style={{ color:'#8b9dc3', fontSize:'0.8rem', textTransform:'uppercase', letterSpacing:'0.05em' }}>Completed</div>
                  <div style={{ color:'#00ff88', fontSize:'2.5rem', fontWeight:900, marginTop:'0.5rem' }}>{completed}</div>
                  <div style={{ color:'#64748b', fontSize:'0.8rem', marginTop:'0.3rem' }}>{completionRate}% completion rate</div>
                </div>
                
                <div style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'14px', padding:'1.5rem' }}>
                  <div style={{ color:'#8b9dc3', fontSize:'0.8rem', textTransform:'uppercase', letterSpacing:'0.05em' }}>Active Now</div>
                  <div style={{ color:'#fbbf24', fontSize:'2.5rem', fontWeight:900, marginTop:'0.5rem' }}>{active}</div>
                  <div style={{ color:'#64748b', fontSize:'0.8rem', marginTop:'0.3rem' }}>{pending} pending, {claimed + inProgress} in work</div>
                </div>
                
                <div style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'14px', padding:'1.5rem' }}>
                  <div style={{ color:'#8b9dc3', fontSize:'0.8rem', textTransform:'uppercase', letterSpacing:'0.05em' }}>Avg Complete Time</div>
                  <div style={{ color:'#00ff88', fontSize:'2.5rem', fontWeight:900, marginTop:'0.5rem' }}>{avgCompletionTime}<span style={{ fontSize:'1.2rem', color:'#8b9dc3' }}>min</span></div>
                </div>
                
                <div style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'14px', padding:'1.5rem' }}>
                  <div style={{ color:'#8b9dc3', fontSize:'0.8rem', textTransform:'uppercase', letterSpacing:'0.05em' }}>High Priority</div>
                  <div style={{ color:'#ff4444', fontSize:'2.5rem', fontWeight:900, marginTop:'0.5rem' }}>{highPriority}</div>
                </div>
                
                <div style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'14px', padding:'1.5rem' }}>
                  <div style={{ color:'#8b9dc3', fontSize:'0.8rem', textTransform:'uppercase', letterSpacing:'0.05em' }}>SLA Compliance</div>
                  <div style={{ color: slaRate >= 90 ? '#00ff88' : slaRate >= 75 ? '#fbbf24' : '#ff4444', fontSize:'2.5rem', fontWeight:900, marginTop:'0.5rem' }}>{slaRate}%</div>
                  <div style={{ color:'#64748b', fontSize:'0.8rem', marginTop:'0.3rem' }}>{slaCompliant} of {completedReqs.length} under {CONFIG.SLA_MINUTES_WARN}min</div>
                </div>
              </div>

              {/* Charts Row */}
              <div style={{ display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(350px, 1fr))', gap:'1.5rem', marginBottom:'1.5rem' }}>
                
                {/* Requests by Status */}
                <div style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'14px', padding:'1.5rem' }}>
                  <div style={{ color:'#00ff88', fontWeight:900, fontSize:'1.1rem', marginBottom:'1.5rem', textTransform:'uppercase', letterSpacing:'0.08em' }}>Requests by Status</div>
                  {statusData.length === 0 ? (
                    <div style={{ color:'#64748b', textAlign:'center', padding:'2rem' }}>No data</div>
                  ) : (
                    <div style={{ display:'flex', flexDirection:'column', gap:'1rem' }}>
                      {statusData.map(stat => (
                        <div key={stat.label}>
                          <div style={{ display:'flex', justifyContent:'space-between', marginBottom:'0.4rem' }}>
                            <span style={{ color:'#e2e8f0', fontSize:'0.9rem' }}>{stat.label}</span>
                            <span style={{ color:'#8b9dc3', fontSize:'0.9rem', fontWeight:900 }}>{stat.count}</span>
                          </div>
                          <div style={{ background:'#1e293b', height:'24px', borderRadius:'8px', overflow:'hidden' }}>
                            <div style={{ background: stat.color, height:'100%', width:`${(stat.count / maxStatusCount) * 100}%`, transition:'width 0.3s ease', display:'flex', alignItems:'center', justifyContent:'flex-end', paddingRight:'0.5rem' }}>
                              <span style={{ color:'#0a0e1a', fontSize:'0.75rem', fontWeight:900 }}>{Math.round((stat.count / total) * 100)}%</span>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Top Rooms */}
                <div style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'14px', padding:'1.5rem' }}>
                  <div style={{ color:'#00ff88', fontWeight:900, fontSize:'1.1rem', marginBottom:'1.5rem', textTransform:'uppercase', letterSpacing:'0.08em' }}>Top Rooms</div>
                  {topRooms.length === 0 ? (
                    <div style={{ color:'#64748b', textAlign:'center', padding:'2rem' }}>No data</div>
                  ) : (
                    <div style={{ display:'flex', flexDirection:'column', gap:'1rem' }}>
                      {topRooms.map(([room, count], idx) => (
                        <div key={room}>
                          <div style={{ display:'flex', justifyContent:'space-between', marginBottom:'0.4rem' }}>
                            <span style={{ color:'#e2e8f0', fontSize:'0.9rem' }}>
                              {idx === 0 && 'ü•á '}{idx === 1 && 'ü•à '}{idx === 2 && 'ü•â '}
                              {room}
                            </span>
                            <span style={{ color:'#8b9dc3', fontSize:'0.9rem', fontWeight:900 }}>{count}</span>
                          </div>
                          <div style={{ background:'#1e293b', height:'24px', borderRadius:'8px', overflow:'hidden' }}>
                            <div style={{ background: 'linear-gradient(90deg, #00ff88, #00cc6f)', height:'100%', width:`${(count / maxRoomCount) * 100}%`, transition:'width 0.3s ease' }} />
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              {/* Staff Performance */}
              {topStaff.length > 0 && (
                <div style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'14px', padding:'1.5rem', marginBottom:'1.5rem' }}>
                  <div style={{ color:'#00ff88', fontWeight:900, fontSize:'1.1rem', marginBottom:'1.5rem', textTransform:'uppercase', letterSpacing:'0.08em' }}>üèÜ Staff Performance</div>
                  <div style={{ display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(250px, 1fr))', gap:'1rem' }}>
                    {topStaff.map((staff, idx) => (
                      <div key={staff.name} style={{ background:'rgba(0,255,136,0.05)', border:'1px solid rgba(0,255,136,0.15)', borderRadius:'10px', padding:'1rem' }}>
                        <div style={{ display:'flex', alignItems:'center', gap:'0.75rem', marginBottom:'0.75rem' }}>
                          <span style={{ fontSize:'1.5rem' }}>{idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : 'üë§'}</span>
                          <div>
                            <div style={{ color:'#e2e8f0', fontWeight:900, fontSize:'1rem' }}>{staff.name}</div>
                            <div style={{ color:'#8b9dc3', fontSize:'0.8rem' }}>{staff.count} completed</div>
                          </div>
                        </div>
                        <div style={{ display:'flex', gap:'1rem' }}>
                          <div>
                            <div style={{ color:'#64748b', fontSize:'0.75rem' }}>Avg Time</div>
                            <div style={{ color:'#00ff88', fontSize:'1.3rem', fontWeight:900 }}>{staff.avgTime}<span style={{ fontSize:'0.8rem' }}>min</span></div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Supervisor Controls */}
              <div style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'14px', padding:'1.25rem' }}>
                <div style={{ color:'#00ff88', fontWeight:900, textTransform:'uppercase', letterSpacing:'0.08em', marginBottom:'1rem' }}>Supervisor Controls</div>
                <div style={{ display:'flex', gap:'0.75rem', flexWrap:'wrap' }}>
                  <button disabled={!canSupervisor} onClick={clearCompleted}
                    style={{ opacity: canSupervisor ? 1 : 0.5, padding:'0.7rem 1rem', borderRadius:'10px', border:'1px solid rgba(0,255,136,0.35)', background:'transparent', color:'#00ff88', fontWeight:900, cursor: canSupervisor ? 'pointer' : 'not-allowed' }}>
                    Clear Completed
                  </button>
                  <button disabled={!canSupervisor} onClick={clearAll}
                    style={{ opacity: canSupervisor ? 1 : 0.5, padding:'0.7rem 1rem', borderRadius:'10px', border:'1px solid #ff4444', background:'transparent', color:'#ff4444', fontWeight:900, cursor: canSupervisor ? 'pointer' : 'not-allowed' }}>
                    Clear ALL
                  </button>
                  <button onClick={loadAll}
                    style={{ padding:'0.7rem 1rem', borderRadius:'10px', border:'1px solid #334155', background:'transparent', color:'#8b9dc3', fontWeight:900, cursor:'pointer' }}>
                    Refresh Data
                  </button>
                </div>

                {!canSupervisor && (
                  <div style={{ marginTop:'0.8rem', color:'#64748b', fontSize:'0.85rem' }}>
                    Supervisor role required for destructive actions.
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      // COMPLETED REQUESTS (History view with export)
      if (screen === "completed") {
        // Filter requests by time
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const thisWeek = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        
        const completedReqs = requests.filter(r => r.status === "completed");
        
        const filteredCompletedReqs = completedReqs.filter(r => {
          const completed = new Date(r.completedAt);
          if (timeFilter === "today") return completed >= today;
          if (timeFilter === "week") return completed >= thisWeek;
          if (timeFilter === "month") return completed >= thisMonth;
          return true; // all
        });

        // Sort by completion time (newest first)
        const sortedCompleted = [...filteredCompletedReqs].sort((a, b) => {
          return new Date(b.completedAt) - new Date(a.completedAt);
        });

        // Calculate stats
        const totalCompleted = sortedCompleted.length;
        const avgTime = sortedCompleted.length > 0 
          ? Math.round(sortedCompleted.reduce((sum, r) => {
              const start = new Date(r.submittedAt);
              const end = new Date(r.completedAt);
              return sum + (end - start) / 60000;
            }, 0) / sortedCompleted.length)
          : 0;

        // CSV Export function
        const exportToCSV = () => {
          const headers = ["ID", "Item", "Room", "Qty", "Priority", "Submitted At", "Submitted By", "Claimed By", "Completed At", "Completed By", "Time (min)", "Comments"];
          
          const rows = sortedCompleted.map(r => {
            const start = new Date(r.submittedAt);
            const end = new Date(r.completedAt);
            const timeMin = Math.round((end - start) / 60000);
            
            return [
              r.id,
              r.item,
              r.room,
              r.qty + (r.adjQty ? ` (adj: ${r.adjQty})` : ''),
              r.priority ? 'HIGH' : 'NORMAL',
              new Date(r.submittedAt).toLocaleString(),
              r.submittedBy || '',
              r.claimedBy || '',
              new Date(r.completedAt).toLocaleString(),
              r.completedBy || '',
              timeMin,
              (r.comments || '').replace(/,/g, ';') // escape commas
            ];
          });

          const csvContent = [
            headers.join(','),
            ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
          ].join('\n');

          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', `completed-requests-${timeFilter}-${new Date().toISOString().split('T')[0]}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        };

        return (
          <div style={{ minHeight:'100vh', ...bg, padding:'1.5rem', position:'relative', overflow:'hidden' }}>
            <div style={gridOverlay} />
            <div style={{ maxWidth:'1400px', margin:'0 auto', position:'relative', zIndex:1 }}>
              <TopBar title="Completed Requests" subtitle={`üë§ ${userName} (${userRole}) ‚Ä¢ ${connectionMode === "supabase" ? "Supabase ready" : "Local + kiosk mode"}`} />

              {/* Time Filter & Export */}
              <div style={{ marginBottom:'1.5rem', display:'flex', gap:'0.75rem', flexWrap:'wrap', justifyContent:'space-between', alignItems:'center' }}>
                <div style={{ display:'flex', gap:'0.75rem', flexWrap:'wrap' }}>
                  {["today", "week", "month", "all"].map(filter => (
                    <button key={filter} onClick={() => setTimeFilter(filter)}
                      style={{
                        padding:'0.6rem 1.2rem', borderRadius:'10px',
                        background: timeFilter === filter ? 'linear-gradient(135deg, #00ff88 0%, #00cc6f 100%)' : 'rgba(15,23,42,0.85)',
                        border: timeFilter === filter ? 'none' : '1px solid #334155',
                        color: timeFilter === filter ? '#0a0e1a' : '#8b9dc3',
                        fontWeight:900, cursor:'pointer', textTransform:'uppercase', fontSize:'0.8rem'
                      }}>
                      {filter === "all" ? "All Time" : filter === "week" ? "This Week" : filter === "month" ? "This Month" : "Today"}
                    </button>
                  ))}
                </div>

                <button onClick={exportToCSV} disabled={sortedCompleted.length === 0}
                  style={{
                    padding:'0.7rem 1.2rem', borderRadius:'10px',
                    background: sortedCompleted.length > 0 ? 'linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%)' : '#334155',
                    border:'none', color:'#fff', fontWeight:900, cursor: sortedCompleted.length > 0 ? 'pointer' : 'not-allowed',
                    textTransform:'uppercase', fontSize:'0.85rem',
                    opacity: sortedCompleted.length > 0 ? 1 : 0.5
                  }}>
                  üì• Export CSV ({totalCompleted})
                </button>
              </div>

              {/* Stats Cards */}
              <div style={{ display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(250px, 1fr))', gap:'1rem', marginBottom:'1.5rem' }}>
                <div style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'14px', padding:'1.5rem' }}>
                  <div style={{ color:'#8b9dc3', fontSize:'0.8rem', textTransform:'uppercase', letterSpacing:'0.05em' }}>Total Completed</div>
                  <div style={{ color:'#00ff88', fontSize:'2.5rem', fontWeight:900, marginTop:'0.5rem' }}>{totalCompleted}</div>
                </div>
                
                <div style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'14px', padding:'1.5rem' }}>
                  <div style={{ color:'#8b9dc3', fontSize:'0.8rem', textTransform:'uppercase', letterSpacing:'0.05em' }}>Avg Complete Time</div>
                  <div style={{ color:'#00ff88', fontSize:'2.5rem', fontWeight:900, marginTop:'0.5rem' }}>{avgTime}<span style={{ fontSize:'1.2rem', color:'#8b9dc3' }}>min</span></div>
                </div>
              </div>

              {/* Completed Requests List */}
              <div style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'14px', overflow:'hidden' }}>
                <div style={{ padding:'1.2rem 1.5rem', background:'linear-gradient(135deg, rgba(0,255,136,0.15) 0%, rgba(0,255,136,0.04) 100%)', borderBottom:'2px solid #00ff88' }}>
                  <div style={{ color:'#00ff88', fontWeight:900, fontSize:'1.1rem', textTransform:'uppercase', letterSpacing:'0.08em' }}>
                    ‚úÖ Completed Requests {timeFilter !== "all" && `(${timeFilter === "today" ? "Today" : timeFilter === "week" ? "This Week" : "This Month"})`}
                  </div>
                </div>

                {sortedCompleted.length === 0 ? (
                  <div style={{ padding:'4rem 2rem', textAlign:'center', color:'#64748b' }}>
                    <CheckCircle size={64} color="#334155" />
                    <h3 style={{ margin:'1rem 0 0 0' }}>No completed requests</h3>
                    <p style={{ margin:'0.5rem 0 0 0', fontSize:'0.9rem' }}>Try changing the time filter</p>
                  </div>
                ) : (
                  <div style={{ overflowX:'auto' }}>
                    <table style={{ width:'100%', borderCollapse:'collapse', minWidth:'1100px' }}>
                      <thead>
                        <tr style={{ background:'rgba(0,255,136,0.05)' }}>
                          <th style={headerStyle}>Item</th>
                          <th style={headerStyle}>Room</th>
                          <th style={headerStyle}>Qty</th>
                          <th style={headerStyle}>Priority</th>
                          <th style={headerStyle}>Submitted</th>
                          <th style={headerStyle}>Completed</th>
                          <th style={headerStyle}>Time</th>
                          <th style={headerStyle}>By</th>
                          <th style={headerStyle}>Comments</th>
                        </tr>
                      </thead>
                      <tbody>
                        {sortedCompleted.map((req, idx) => {
                          const start = new Date(req.submittedAt);
                          const end = new Date(req.completedAt);
                          const timeMin = Math.round((end - start) / 60000);
                          const timeColor = timeMin <= 5 ? '#00ff88' : timeMin <= 10 ? '#fbbf24' : '#ff4444';

                          return (
                            <tr key={req.id} style={{ borderBottom: idx < sortedCompleted.length - 1 ? '1px solid #334155' : 'none', background: idx % 2 === 0 ? 'transparent' : 'rgba(0,255,136,0.02)' }}>
                              <td style={cellStyle}>
                                <div style={{ fontWeight:900 }}>{req.item}</div>
                              </td>
                              <td style={cellStyle}>
                                <div style={{ display:'flex', alignItems:'center', gap:'0.4rem' }}>
                                  <MapPin size={14} color="#8b9dc3" />
                                  {req.room}
                                </div>
                              </td>
                              <td style={cellStyle}>
                                <div style={{ fontWeight:900 }}>{req.qty}</div>
                                {req.adjQty > 0 && <div style={{ fontSize:'0.75rem', color:'#8b9dc3' }}>adj: {req.adjQty}</div>}
                              </td>
                              <td style={cellStyle}>
                                {req.priority && <span style={{ padding:'0.3rem 0.6rem', background:'#ff4444', borderRadius:'8px', color:'#fff', fontWeight:900, fontSize:'0.7rem' }}>HIGH</span>}
                              </td>
                              <td style={cellStyle}>
                                <div style={{ fontSize:'0.85rem' }}>{niceTime(req.submittedAt)}</div>
                                <div style={{ fontSize:'0.75rem', color:'#8b9dc3' }}>{req.submittedBy}</div>
                              </td>
                              <td style={cellStyle}>
                                <div style={{ fontSize:'0.85rem' }}>{niceTime(req.completedAt)}</div>
                                <div style={{ fontSize:'0.75rem', color:'#00ff88' }}>{req.completedBy}</div>
                              </td>
                              <td style={cellStyle}>
                                <div style={{ fontWeight:900, color: timeColor, fontSize:'1.1rem' }}>
                                  {timeMin}<span style={{ fontSize:'0.75rem' }}>min</span>
                                </div>
                              </td>
                              <td style={cellStyle}>
                                <div style={{ fontSize:'0.85rem', color:'#8b9dc3' }}>{req.claimedBy || '‚Äî'}</div>
                              </td>
                              <td style={cellStyle}>
                                <div style={{ fontSize:'0.85rem', color:'#8b9dc3', maxWidth:'200px', overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap' }}>
                                  {req.comments || '‚Äî'}
                                </div>
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      // ADMIN PANEL (Admin-only: user management + room analytics)
      if (screen === "admin") {
        if (!canAdmin) {
          return (
            <div style={{ minHeight:'100vh', ...bg, padding:'1.5rem', display:'flex', alignItems:'center', justifyContent:'center' }}>
              <div style={{ textAlign:'center', color:'#ff4444' }}>
                <h2>‚ö†Ô∏è Admin Access Required</h2>
                <p>You must be signed in as Admin to access this page.</p>
                <button onClick={()=> setRoute("login")} style={{ padding:'0.7rem 1.5rem', background:'#ff4444', border:'none', borderRadius:'8px', color:'#fff', fontWeight:900, cursor:'pointer', marginTop:'1rem' }}>Go to Login</button>
              </div>
            </div>
          );
        }

        // Room stats helpers
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const thisWeek = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const thisYear = new Date(now.getFullYear(), 0, 1);

        const getRoomStats = (filterFn) => {
          const filtered = requests.filter(filterFn);
          const byRoom = {};
          filtered.forEach(r => {
            if (!byRoom[r.room]) byRoom[r.room] = { total:0, completed:0, pending:0, inProgress:0, times:[] };
            byRoom[r.room].total++;
            if (r.status === 'completed') {
              byRoom[r.room].completed++;
              if (r.submittedAt && r.completedAt)
                byRoom[r.room].times.push((new Date(r.completedAt) - new Date(r.submittedAt)) / 60000);
            }
            if (r.status === 'pending') byRoom[r.room].pending++;
            if (r.status === 'in_progress' || r.status === 'claimed') byRoom[r.room].inProgress++;
          });
          return Object.entries(byRoom).map(([room, s]) => ({
            room, ...s,
            avgTime: s.times.length > 0 ? Math.round(s.times.reduce((a,b)=>a+b,0)/s.times.length) : 0
          })).sort((a,b) => b.total - a.total);
        };

        const roomStats = getRoomStats(r => {
          const submitted = new Date(r.submittedAt);
          if (adminTimeFilter === "day") return submitted >= today;
          if (adminTimeFilter === "week") return submitted >= thisWeek;
          if (adminTimeFilter === "month") return submitted >= thisMonth;
          if (adminTimeFilter === "year") return submitted >= thisYear;
          return true;
        });
        const maxRoomTotal = roomStats.length > 0 ? roomStats[0].total : 1;

        const handleCreateUser = () => {
          const name = newUserName.trim();
          if (!name) { alert("Enter a name"); return; }
          if (users.find(u => u.name.toLowerCase() === name.toLowerCase())) { alert("A user with that name already exists!"); return; }
          saveUsers([...users, { id: genId(), name, role: newUserRole, createdAt: new Date().toISOString(), createdBy: userName }]);
          setNewUserName(""); setNewUserRole("room");
          setSuccessMsg(`User "${name}" created successfully!`);
          setTimeout(() => setSuccessMsg(""), 3000);
        };

        const handleDeleteUser = (id, name) => {
          if (!confirm(`Delete user "${name}"? They will no longer be able to sign in.`)) return;
          saveUsers(users.filter(u => u.id !== id));
          setSuccessMsg(`User "${name}" deleted.`);
          setTimeout(() => setSuccessMsg(""), 3000);
        };

        const handleUpdateUser = (id) => {
          const name = editUserName.trim();
          if (!name) { alert("Name cannot be empty"); return; }
          saveUsers(users.map(u => u.id === id ? { ...u, name, role: editUserRole } : u));
          setEditUserId(null);
          setSuccessMsg("User updated!");
          setTimeout(() => setSuccessMsg(""), 3000);
        };

        const exportRoomCSV = () => {
          const headers = ["Room","Total","Completed","Pending","In Progress","Avg Time (min)","Completion %"];
          const rows = roomStats.map(r => [r.room, r.total, r.completed, r.pending, r.inProgress, r.avgTime,
            r.total > 0 ? Math.round((r.completed/r.total)*100) : 0]);
          const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
          const blob = new Blob([csv], { type:'text/csv' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `room-stats-${adminTimeFilter}-${new Date().toISOString().split('T')[0]}.csv`;
          a.click();
        };

        const roleColors = { room:'#8b9dc3', warehouse:'#fbbf24', supervisor:'#a78bfa', admin:'#ff4444' };
        const roleEmojis = { room:'üçΩÔ∏è', warehouse:'üì¶', supervisor:'üß≠', admin:'üîß' };

        return (
          <div style={{ minHeight:'100vh', ...bg, padding:'1.5rem', position:'relative', overflow:'hidden' }}>
            <div style={gridOverlay} />
            <div style={{ maxWidth:'1600px', margin:'0 auto', position:'relative', zIndex:1 }}>
              <TopBar title="Admin Panel" subtitle={`üë§ ${userName} (${userRole}) ‚Ä¢ ${connectionMode === "supabase" ? "Supabase ready" : "Local + kiosk mode"}`} />

              {successMsg && (
                <div style={{ padding:'1rem', background:'rgba(0,255,136,0.15)', border:'1px solid #00ff88', borderRadius:'10px', color:'#00ff88', marginBottom:'1rem', fontWeight:900 }}>‚úÖ {successMsg}</div>
              )}

              {/* ‚ïê‚ïê‚ïê USER MANAGEMENT ‚ïê‚ïê‚ïê */}
              <div style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(255,68,68,0.3)', borderRadius:'14px', padding:'1.5rem', marginBottom:'1.5rem' }}>
                <div style={{ color:'#ff4444', fontWeight:900, fontSize:'1.3rem', textTransform:'uppercase', letterSpacing:'0.08em', marginBottom:'1.5rem' }}>üë• User Management</div>

                {/* Create New User */}
                <div style={{ background:'rgba(255,68,68,0.06)', border:'1px solid rgba(255,68,68,0.2)', borderRadius:'10px', padding:'1.25rem', marginBottom:'1.5rem' }}>
                  <div style={{ color:'#ff4444', fontWeight:800, fontSize:'0.9rem', textTransform:'uppercase', letterSpacing:'0.06em', marginBottom:'1rem' }}>‚ûï Create New User</div>
                  <div style={{ display:'flex', gap:'0.75rem', flexWrap:'wrap', alignItems:'flex-end' }}>
                    <div style={{ flex:'1 1 220px' }}>
                      <div style={{ color:'#8b9dc3', fontSize:'0.75rem', fontWeight:700, marginBottom:'0.4rem', textTransform:'uppercase' }}>Name</div>
                      <input value={newUserName} onChange={e => setNewUserName(e.target.value)}
                        onKeyDown={e => e.key === "Enter" && handleCreateUser()}
                        placeholder="Enter full name..."
                        style={{ width:'100%', padding:'0.75rem', background:'#1e293b', border:'1px solid #334155', borderRadius:'8px', color:'#e2e8f0', fontSize:'0.95rem' }} />
                    </div>
                    <div style={{ flex:'1 1 200px' }}>
                      <div style={{ color:'#8b9dc3', fontSize:'0.75rem', fontWeight:700, marginBottom:'0.4rem', textTransform:'uppercase' }}>Role</div>
                      <div style={{ display:'flex', gap:'0.5rem' }}>
                        {["room","warehouse","supervisor","admin"].map(r => (
                          <button key={r} onClick={() => setNewUserRole(r)}
                            style={{ flex:1, padding:'0.6rem 0.3rem', borderRadius:'6px', border: newUserRole===r ? `2px solid ${roleColors[r]}` : '2px solid #334155',
                              background: newUserRole===r ? `${roleColors[r]}22` : '#1e293b',
                              color: newUserRole===r ? roleColors[r] : '#64748b',
                              fontWeight:900, cursor:'pointer', fontSize:'0.7rem', textTransform:'uppercase' }}>
                            {roleEmojis[r]}
                          </button>
                        ))}
                      </div>
                      <div style={{ color: roleColors[newUserRole], fontSize:'0.75rem', marginTop:'0.3rem', fontWeight:700, textTransform:'uppercase' }}>
                        {roleEmojis[newUserRole]} {newUserRole}
                      </div>
                    </div>
                    <button onClick={handleCreateUser}
                      style={{ padding:'0.75rem 1.5rem', background:'linear-gradient(135deg, #ff4444 0%, #cc3333 100%)', border:'none', borderRadius:'8px', color:'#fff', fontWeight:900, cursor:'pointer', textTransform:'uppercase', whiteSpace:'nowrap' }}>
                      ‚ûï Add User
                    </button>
                  </div>
                </div>

                {/* Users List */}
                <div style={{ color:'#8b9dc3', fontSize:'0.8rem', fontWeight:700, marginBottom:'0.75rem', textTransform:'uppercase' }}>
                  Registered Users ({users.length})
                </div>
                {users.length === 0 ? (
                  <div style={{ padding:'2rem', textAlign:'center', color:'#64748b' }}>No users yet. Create one above.</div>
                ) : (
                  <div style={{ display:'flex', flexDirection:'column', gap:'0.5rem' }}>
                    {users.map(u => (
                      <div key={u.id} style={{ padding:'1rem', background:'rgba(255,68,68,0.04)', border:'1px solid rgba(255,68,68,0.12)', borderRadius:'10px', display:'flex', alignItems:'center', gap:'1rem', flexWrap:'wrap' }}>
                        {editUserId === u.id ? (
                          <>
                            <input value={editUserName} onChange={e => setEditUserName(e.target.value)}
                              style={{ flex:'1 1 180px', padding:'0.5rem', background:'#1e293b', border:'1px solid #334155', borderRadius:'6px', color:'#e2e8f0', fontSize:'0.9rem' }} />
                            <div style={{ display:'flex', gap:'0.4rem' }}>
                              {["room","warehouse","supervisor","admin"].map(r => (
                                <button key={r} onClick={() => setEditUserRole(r)}
                                  style={{ padding:'0.4rem 0.6rem', borderRadius:'6px', border: editUserRole===r ? `2px solid ${roleColors[r]}` : '2px solid #334155',
                                    background: editUserRole===r ? `${roleColors[r]}22` : '#1e293b',
                                    color: editUserRole===r ? roleColors[r] : '#64748b',
                                    fontWeight:900, cursor:'pointer', fontSize:'0.7rem' }}>
                                  {roleEmojis[r]} {r}
                                </button>
                              ))}
                            </div>
                            <div style={{ display:'flex', gap:'0.5rem' }}>
                              <button onClick={() => handleUpdateUser(u.id)}
                                style={{ padding:'0.5rem 1rem', background:'#00ff88', border:'none', borderRadius:'6px', color:'#0a0e1a', fontWeight:900, cursor:'pointer', fontSize:'0.8rem' }}>Save</button>
                              <button onClick={() => setEditUserId(null)}
                                style={{ padding:'0.5rem 1rem', background:'#334155', border:'none', borderRadius:'6px', color:'#e2e8f0', fontWeight:900, cursor:'pointer', fontSize:'0.8rem' }}>Cancel</button>
                            </div>
                          </>
                        ) : (
                          <>
                            <div style={{ flex:'1 1 200px' }}>
                              <div style={{ fontWeight:900, color:'#e2e8f0', fontSize:'1rem' }}>{u.name}</div>
                              <div style={{ fontSize:'0.8rem', marginTop:'0.2rem' }}>
                                <span style={{ color: roleColors[u.role], fontWeight:700 }}>{roleEmojis[u.role]} {u.role}</span>
                                <span style={{ color:'#4b5563', marginLeft:'0.75rem' }}>Added {new Date(u.createdAt).toLocaleDateString()}</span>
                                {u.createdBy !== "system" && <span style={{ color:'#4b5563' }}> by {u.createdBy}</span>}
                              </div>
                            </div>
                            <div style={{ display:'flex', gap:'0.5rem' }}>
                              <button onClick={() => { setEditUserId(u.id); setEditUserName(u.name); setEditUserRole(u.role); }}
                                style={{ padding:'0.5rem 1rem', background:'rgba(56,189,248,0.15)', border:'1px solid #38bdf8', borderRadius:'6px', color:'#38bdf8', fontWeight:900, cursor:'pointer', fontSize:'0.8rem' }}>
                                ‚úèÔ∏è Edit
                              </button>
                              {u.name !== userName && (
                                <button onClick={() => handleDeleteUser(u.id, u.name)}
                                  style={{ padding:'0.5rem 1rem', background:'rgba(255,68,68,0.1)', border:'1px solid #ff4444', borderRadius:'6px', color:'#ff4444', fontWeight:900, cursor:'pointer', fontSize:'0.8rem' }}>
                                  üóëÔ∏è Delete
                                </button>
                              )}
                            </div>
                          </>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* ‚ïê‚ïê‚ïê ROOM ANALYTICS ‚ïê‚ïê‚ïê */}
              <div style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(255,68,68,0.2)', borderRadius:'14px', padding:'1.5rem', marginBottom:'1.5rem' }}>
                <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1.25rem', flexWrap:'wrap', gap:'1rem' }}>
                  <div style={{ color:'#ff4444', fontWeight:900, fontSize:'1.3rem', textTransform:'uppercase', letterSpacing:'0.08em' }}>üìä Room Analytics</div>
                  <button onClick={exportRoomCSV} disabled={roomStats.length === 0}
                    style={{ padding:'0.6rem 1.2rem', borderRadius:'8px', background: roomStats.length > 0 ? 'linear-gradient(135deg,#ff4444,#cc3333)' : '#334155', border:'none', color:'#fff', fontWeight:900, cursor: roomStats.length > 0 ? 'pointer' : 'not-allowed', textTransform:'uppercase', fontSize:'0.8rem' }}>
                    üì• Export CSV
                  </button>
                </div>
                <div style={{ display:'flex', gap:'0.6rem', flexWrap:'wrap', marginBottom:'1.25rem' }}>
                  {["day","week","month","year","all"].map(f => (
                    <button key={f} onClick={() => setAdminTimeFilter(f)}
                      style={{ padding:'0.5rem 1rem', borderRadius:'8px', background: adminTimeFilter===f ? 'linear-gradient(135deg,#ff4444,#cc3333)' : 'rgba(15,23,42,0.85)',
                        border: adminTimeFilter===f ? 'none' : '1px solid #334155', color: adminTimeFilter===f ? '#fff' : '#8b9dc3',
                        fontWeight:900, cursor:'pointer', textTransform:'uppercase', fontSize:'0.78rem' }}>
                      {f==="all"?"All Time":f==="day"?"Today":f==="week"?"This Week":f==="month"?"This Month":"This Year"}
                    </button>
                  ))}
                </div>
                {roomStats.length === 0 ? (
                  <div style={{ padding:'2rem', textAlign:'center', color:'#64748b' }}>No data for this period</div>
                ) : (
                  <div style={{ overflowX:'auto' }}>
                    <table style={{ width:'100%', borderCollapse:'collapse' }}>
                      <thead>
                        <tr style={{ background:'rgba(255,68,68,0.1)' }}>
                          {["Room","Total","Completed","Pending","In Progress","Avg Time","Rate","Activity"].map(h => (
                            <th key={h} style={headerStyle}>{h}</th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {roomStats.map((room, idx) => {
                          const rate = room.total > 0 ? Math.round((room.completed/room.total)*100) : 0;
                          const tColor = room.avgTime <= 5 ? '#00ff88' : room.avgTime <= 10 ? '#fbbf24' : '#ff4444';
                          const rColor = rate >= 80 ? '#00ff88' : rate >= 50 ? '#fbbf24' : '#ff4444';
                          return (
                            <tr key={room.room} style={{ borderBottom: idx < roomStats.length-1 ? '1px solid #334155' : 'none', background: idx%2===0 ? 'transparent' : 'rgba(255,68,68,0.02)' }}>
                              <td style={cellStyle}><div style={{ fontWeight:900, display:'flex', alignItems:'center', gap:'0.4rem' }}><MapPin size={14} color="#ff4444" />{room.room}</div></td>
                              <td style={cellStyle}><div style={{ fontWeight:900, color:'#ff4444', fontSize:'1.1rem' }}>{room.total}</div></td>
                              <td style={cellStyle}><div style={{ color:'#00ff88', fontWeight:700 }}>{room.completed}</div></td>
                              <td style={cellStyle}><div style={{ color:'#fbbf24', fontWeight:700 }}>{room.pending}</div></td>
                              <td style={cellStyle}><div style={{ color:'#38bdf8', fontWeight:700 }}>{room.inProgress}</div></td>
                              <td style={cellStyle}><div style={{ fontWeight:900, color:tColor }}>{room.avgTime > 0 ? `${room.avgTime}min` : '‚Äî'}</div></td>
                              <td style={cellStyle}><div style={{ fontWeight:900, color:rColor }}>{rate}%</div></td>
                              <td style={cellStyle}>
                                <div style={{ background:'#1e293b', height:'8px', borderRadius:'4px', overflow:'hidden', width:'100px' }}>
                                  <div style={{ background:'linear-gradient(90deg,#ff4444,#ff6666)', height:'100%', width:`${(room.total/maxRoomTotal)*100}%` }} />
                                </div>
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>

              {/* ‚ïê‚ïê‚ïê REQUEST MANAGEMENT ‚ïê‚ïê‚ïê */}
              <div style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(255,68,68,0.2)', borderRadius:'14px', padding:'1.5rem' }}>
                <div style={{ color:'#ff4444', fontWeight:900, fontSize:'1.3rem', textTransform:'uppercase', letterSpacing:'0.08em', marginBottom:'1rem' }}>üîß Request Management</div>
                <div style={{ display:'flex', gap:'0.75rem', flexWrap:'wrap', marginBottom:'1rem' }}>
                  <button onClick={clearCompleted} style={{ padding:'0.7rem 1.2rem', borderRadius:'10px', border:'1px solid rgba(255,68,68,0.35)', background:'transparent', color:'#ff4444', fontWeight:900, cursor:'pointer', textTransform:'uppercase' }}>Clear Completed</button>
                  <button onClick={clearAll} style={{ padding:'0.7rem 1.2rem', borderRadius:'10px', border:'1px solid #ff4444', background:'rgba(255,68,68,0.1)', color:'#ff4444', fontWeight:900, cursor:'pointer', textTransform:'uppercase' }}>‚ö†Ô∏è Clear ALL</button>
                  <button onClick={loadAll} style={{ padding:'0.7rem 1.2rem', borderRadius:'10px', border:'1px solid #334155', background:'transparent', color:'#8b9dc3', fontWeight:900, cursor:'pointer', textTransform:'uppercase' }}>üîÑ Refresh</button>
                </div>
                {requests.slice(0,10).map(req => (
                  <div key={req.id} style={{ padding:'0.85rem', background:'rgba(255,68,68,0.04)', border:'1px solid rgba(255,68,68,0.12)', borderRadius:'8px', display:'flex', justifyContent:'space-between', alignItems:'center', gap:'1rem', flexWrap:'wrap', marginBottom:'0.5rem' }}>
                    <div>
                      <div style={{ fontWeight:900, color:'#e2e8f0' }}>{req.qty}√ó {req.item}</div>
                      <div style={{ fontSize:'0.8rem', color:'#8b9dc3' }}>{req.room} ‚Ä¢ {req.status} ‚Ä¢ by {req.submittedBy}
                        {req.priority && <span style={{ marginLeft:'0.5rem', padding:'0.15rem 0.4rem', background:'#ff4444', borderRadius:'4px', color:'#fff', fontSize:'0.65rem' }}>HIGH</span>}
                      </div>
                    </div>
                    <button onClick={() => deleteRequest(req.id)}
                      style={{ padding:'0.45rem 0.9rem', background:'linear-gradient(135deg,#ff4444,#cc3333)', border:'none', borderRadius:'6px', color:'#fff', fontWeight:900, cursor:'pointer', fontSize:'0.8rem' }}>
                      üóëÔ∏è Delete
                    </button>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }

      // ASSIGNMENTS (Supervisor + Admin: assign people to rooms)
      if (screen === "assignments") {
        if (!canSupervisor) {
          return (
            <div style={{ minHeight:'100vh', ...bg, display:'flex', alignItems:'center', justifyContent:'center' }}>
              <div style={{ textAlign:'center', color:'#fbbf24' }}>
                <h2>‚ö†Ô∏è Supervisor Access Required</h2>
                <button onClick={()=> setRoute("picklist")} style={{ padding:'0.7rem 1.5rem', background:'#fbbf24', border:'none', borderRadius:'8px', color:'#0a0e1a', fontWeight:900, cursor:'pointer', marginTop:'1rem' }}>Go Back</button>
              </div>
            </div>
          );
        }

        const durationOptions = [
          { key:"day", label:"üìÖ Day", desc:"Expires tomorrow" },
          { key:"week", label:"üìÖ Week", desc:"Expires in 7 days" },
          { key:"month", label:"üìÖ Month", desc:"Expires in 1 month" },
          { key:"year", label:"üìÖ Year", desc:"Expires in 1 year" }
        ];

        const handleAssign = () => {
          if (!assignPerson) { alert("Select a person"); return; }
          if (!assignRoom) { alert("Select a room"); return; }
          const person = users.find(u => u.id === assignPerson);
          if (!person) return;
          // Check if already assigned to this room
          const existing = activeAssignments.find(a => a.userId === assignPerson && a.room === assignRoom);
          if (existing) {
            if (!confirm(`${person.name} is already assigned to ${assignRoom}. Replace the assignment?`)) return;
            saveAssignments(assignments.filter(a => !(a.userId === assignPerson && a.room === assignRoom)));
          }
          const newAssignment = {
            id: genId(), userId: person.id, userName: person.name, userRole: person.role,
            room: assignRoom, duration: assignDuration,
            startDate: new Date().toISOString(), expiresAt: expiryDate(assignDuration),
            assignedBy: userName, assignedAt: new Date().toISOString()
          };
          saveAssignments([...assignments.filter(a => !(a.userId === assignPerson && a.room === assignRoom)), newAssignment]);
          setSuccessMsg(`${person.name} assigned to ${assignRoom} for 1 ${assignDuration}!`);
          setTimeout(() => setSuccessMsg(""), 3000);
          setAssignPerson(""); setAssignRoom("");
        };

        const removeAssignment = (id, name, room) => {
          if (!confirm(`Remove ${name}'s assignment from ${room}?`)) return;
          saveAssignments(assignments.filter(a => a.id !== id));
        };

        const durationColor = { day:'#38bdf8', week:'#a78bfa', month:'#fbbf24', year:'#00ff88' };
        const roleColors2 = { room:'#8b9dc3', warehouse:'#fbbf24', supervisor:'#a78bfa', admin:'#ff4444' };

        // Group active assignments by room
        const byRoom = {};
        activeAssignments.forEach(a => {
          if (!byRoom[a.room]) byRoom[a.room] = [];
          byRoom[a.room].push(a);
        });

        return (
          <div style={{ minHeight:'100vh', ...bg, padding:'1.5rem', position:'relative', overflow:'hidden' }}>
            <div style={gridOverlay} />
            <div style={{ maxWidth:'1400px', margin:'0 auto', position:'relative', zIndex:1 }}>
              <TopBar title="Room Assignments" subtitle={`üë§ ${userName} (${userRole}) ‚Ä¢ ${connectionMode === "supabase" ? "Supabase ready" : "Local + kiosk mode"}`} />

              {successMsg && (
                <div style={{ padding:'1rem', background:'rgba(0,255,136,0.15)', border:'1px solid #00ff88', borderRadius:'10px', color:'#00ff88', marginBottom:'1rem', fontWeight:900 }}>‚úÖ {successMsg}</div>
              )}

              <div style={{ display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(380px, 1fr))', gap:'1.5rem', marginBottom:'1.5rem' }}>

                {/* Assign Form */}
                <div style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(56,189,248,0.3)', borderRadius:'14px', padding:'1.5rem' }}>
                  <div style={{ color:'#38bdf8', fontWeight:900, fontSize:'1.2rem', textTransform:'uppercase', letterSpacing:'0.08em', marginBottom:'1.25rem' }}>‚ûï Assign Person to Room</div>

                  <div style={{ marginBottom:'1rem' }}>
                    <div style={{ color:'#8b9dc3', fontSize:'0.78rem', fontWeight:700, textTransform:'uppercase', marginBottom:'0.5rem' }}>Select Person</div>
                    <select value={assignPerson} onChange={e => setAssignPerson(e.target.value)}
                      style={{ width:'100%', padding:'0.75rem', background:'#1e293b', border:'1px solid #334155', borderRadius:'8px', color:'#e2e8f0', fontSize:'0.95rem' }}>
                      <option value="">-- Choose person --</option>
                      {users.filter(u => u.role !== 'admin').map(u => (
                        <option key={u.id} value={u.id}>{u.name} ({u.role})</option>
                      ))}
                    </select>
                  </div>

                  <div style={{ marginBottom:'1rem' }}>
                    <div style={{ color:'#8b9dc3', fontSize:'0.78rem', fontWeight:700, textTransform:'uppercase', marginBottom:'0.5rem' }}>Select Room</div>
                    <select value={assignRoom} onChange={e => setAssignRoom(e.target.value)}
                      style={{ width:'100%', padding:'0.75rem', background:'#1e293b', border:'1px solid #334155', borderRadius:'8px', color:'#e2e8f0', fontSize:'0.95rem' }}>
                      <option value="">-- Choose room --</option>
                      {rooms.map(r => (
                        <option key={r} value={r}>{r}</option>
                      ))}
                    </select>
                  </div>

                  <div style={{ marginBottom:'1.25rem' }}>
                    <div style={{ color:'#8b9dc3', fontSize:'0.78rem', fontWeight:700, textTransform:'uppercase', marginBottom:'0.5rem' }}>Duration</div>
                    <div style={{ display:'grid', gridTemplateColumns:'1fr 1fr 1fr 1fr', gap:'0.5rem' }}>
                      {durationOptions.map(d => (
                        <button key={d.key} onClick={() => setAssignDuration(d.key)}
                          style={{ padding:'0.75rem 0.4rem', borderRadius:'8px', textAlign:'center',
                            border: assignDuration===d.key ? `2px solid ${durationColor[d.key]}` : '2px solid #334155',
                            background: assignDuration===d.key ? `${durationColor[d.key]}22` : '#1e293b',
                            color: assignDuration===d.key ? durationColor[d.key] : '#64748b',
                            fontWeight:900, cursor:'pointer', fontSize:'0.8rem', textTransform:'uppercase' }}>
                          {d.key.charAt(0).toUpperCase() + d.key.slice(1)}
                        </button>
                      ))}
                    </div>
                    <div style={{ marginTop:'0.5rem', color:'#64748b', fontSize:'0.78rem' }}>
                      {durationOptions.find(d => d.key === assignDuration)?.desc}
                      {' ‚Ä¢ '}Expires: {new Date(expiryDate(assignDuration)).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}
                    </div>
                  </div>

                  <button onClick={handleAssign}
                    style={{ width:'100%', padding:'1rem', background:'linear-gradient(135deg,#38bdf8,#0ea5e9)', border:'none', borderRadius:'10px', color:'#fff', fontWeight:900, cursor:'pointer', textTransform:'uppercase', fontSize:'1rem', letterSpacing:'0.05em' }}>
                    ‚ûï Assign to Room
                  </button>
                </div>

                {/* Stats */}
                <div style={{ display:'flex', flexDirection:'column', gap:'1rem' }}>
                  <div style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(56,189,248,0.2)', borderRadius:'14px', padding:'1.5rem' }}>
                    <div style={{ color:'#8b9dc3', fontSize:'0.8rem', textTransform:'uppercase', letterSpacing:'0.05em' }}>Active Assignments</div>
                    <div style={{ color:'#38bdf8', fontSize:'2.5rem', fontWeight:900, marginTop:'0.5rem' }}>{activeAssignments.length}</div>
                  </div>
                  <div style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(56,189,248,0.2)', borderRadius:'14px', padding:'1.5rem' }}>
                    <div style={{ color:'#8b9dc3', fontSize:'0.8rem', textTransform:'uppercase', letterSpacing:'0.05em' }}>Rooms with Assignments</div>
                    <div style={{ color:'#38bdf8', fontSize:'2.5rem', fontWeight:900, marginTop:'0.5rem' }}>{Object.keys(byRoom).length}</div>
                  </div>
                  <div style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(56,189,248,0.2)', borderRadius:'14px', padding:'1.5rem' }}>
                    <div style={{ color:'#8b9dc3', fontSize:'0.8rem', textTransform:'uppercase', letterSpacing:'0.05em' }}>Total Users</div>
                    <div style={{ color:'#38bdf8', fontSize:'2.5rem', fontWeight:900, marginTop:'0.5rem' }}>{users.length}</div>
                  </div>
                </div>
              </div>

              {/* Active Assignments Table */}
              <div style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(56,189,248,0.2)', borderRadius:'14px', overflow:'hidden' }}>
                <div style={{ padding:'1.2rem 1.5rem', background:'linear-gradient(135deg,rgba(56,189,248,0.15) 0%,rgba(56,189,248,0.04) 100%)', borderBottom:'2px solid #38bdf8' }}>
                  <div style={{ color:'#38bdf8', fontWeight:900, fontSize:'1.1rem', textTransform:'uppercase', letterSpacing:'0.08em' }}>
                    üìã All Active Assignments ({activeAssignments.length})
                  </div>
                </div>

                {activeAssignments.length === 0 ? (
                  <div style={{ padding:'4rem', textAlign:'center', color:'#64748b' }}>
                    <div style={{ fontSize:'3rem', marginBottom:'1rem' }}>üìã</div>
                    <h3 style={{ margin:'0 0 0.5rem 0' }}>No active assignments</h3>
                    <p style={{ margin:0, fontSize:'0.9rem' }}>Use the form above to assign people to rooms</p>
                  </div>
                ) : (
                  <div style={{ overflowX:'auto' }}>
                    <table style={{ width:'100%', borderCollapse:'collapse', minWidth:'750px' }}>
                      <thead>
                        <tr style={{ background:'rgba(56,189,248,0.06)' }}>
                          {["Person","Role","Room","Duration","Assigned By","Expires","Actions"].map(h => (
                            <th key={h} style={headerStyle}>{h}</th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {activeAssignments.sort((a,b) => a.room.localeCompare(b.room)).map((a, idx) => {
                          const expires = new Date(a.expiresAt);
                          const daysLeft = Math.ceil((expires - new Date()) / (1000*60*60*24));
                          const expiryColor = daysLeft <= 1 ? '#ff4444' : daysLeft <= 3 ? '#fbbf24' : '#00ff88';
                          return (
                            <tr key={a.id} style={{ borderBottom: idx < activeAssignments.length-1 ? '1px solid #334155' : 'none', background: idx%2===0 ? 'transparent' : 'rgba(56,189,248,0.02)' }}>
                              <td style={cellStyle}><div style={{ fontWeight:900 }}>{a.userName}</div></td>
                              <td style={cellStyle}><span style={{ color: roleColors2[a.userRole], fontWeight:700, textTransform:'uppercase', fontSize:'0.85rem' }}>{a.userRole}</span></td>
                              <td style={cellStyle}><div style={{ display:'flex', alignItems:'center', gap:'0.4rem' }}><MapPin size={14} color="#38bdf8" />{a.room}</div></td>
                              <td style={cellStyle}><span style={{ padding:'0.25rem 0.6rem', borderRadius:'6px', background:`${durationColor[a.duration]}22`, color:durationColor[a.duration], fontWeight:900, fontSize:'0.8rem', textTransform:'uppercase' }}>{a.duration}</span></td>
                              <td style={cellStyle}><div style={{ color:'#8b9dc3', fontSize:'0.85rem' }}>{a.assignedBy}</div></td>
                              <td style={cellStyle}>
                                <div style={{ color:expiryColor, fontWeight:700, fontSize:'0.85rem' }}>
                                  {expires.toLocaleDateString('en-US',{month:'short',day:'numeric'})}
                                </div>
                                <div style={{ color: expiryColor, fontSize:'0.75rem' }}>
                                  {daysLeft <= 0 ? 'Expired' : daysLeft === 1 ? 'Tomorrow' : `${daysLeft} days`}
                                </div>
                              </td>
                              <td style={cellStyle}>
                                <button onClick={() => removeAssignment(a.id, a.userName, a.room)}
                                  style={{ padding:'0.4rem 0.8rem', background:'rgba(255,68,68,0.1)', border:'1px solid #ff4444', borderRadius:'6px', color:'#ff4444', fontWeight:900, cursor:'pointer', fontSize:'0.8rem' }}>
                                  Remove
                                </button>
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }


      // PICKLIST (Main operational screen)
      if (screen === "picklist") {
        return (
          <div style={{ minHeight:'100vh', ...bg, padding:'1.5rem', position:'relative', overflow:'hidden' }}>
            <div style={gridOverlay} />
            <div style={{ maxWidth:'1500px', margin:'0 auto', position:'relative', zIndex:1 }}>
              <TopBar title="Pick List" subtitle={`üë§ ${userName} (${userRole}) ‚Ä¢ ${connectionMode === "supabase" ? "Supabase ready ‚Ä¢ Realtime updates" : "Local + kiosk mode"}`} />

              <div style={{ marginBottom:'0.9rem', padding:'0.6rem 0.9rem', background:'rgba(0,255,136,0.1)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'10px', color:'#00ff88', fontSize:'0.75rem', textAlign:'center', letterSpacing:'0.05em' }}>
                ‚úÖ Claim ‚Üí Start ‚Üí Done ‚Ä¢ Prevents double-picking (multi-user safe)
              </div>

              <div style={{ display:'flex', gap:'0.75rem', flexWrap:'wrap', alignItems:'center', marginBottom:'0.9rem' }}>
                <div style={{ color:'#64748b', fontSize:'0.75rem' }}>Group:</div>
                <select value={viewGroup} onChange={(e)=> setViewGroup(e.target.value)}
                  style={{ background:'#1e293b', border:'1px solid #334155', color:'#e2e8f0', padding:'0.45rem 0.6rem', borderRadius:'8px' }}>
                  <option value="room">Room</option>
                  <option value="item">Item</option>
                  <option value="status">Status</option>
                </select>

                <label style={{ display:'flex', alignItems:'center', gap:'0.4rem', color:'#8b9dc3', fontSize:'0.8rem' }}>
                  <input type="checkbox" checked={onlyActive} onChange={(e)=> setOnlyActive(e.target.checked)} />
                  Active only
                </label>

                <input value={search} onChange={(e)=> setSearch(e.target.value)} placeholder="Search item / room / person‚Ä¶"
                  style={{ flex:'1 1 280px', background:'#1e293b', border:'1px solid #334155', color:'#e2e8f0', padding:'0.6rem 0.7rem', borderRadius:'10px' }} />

                <select value={sortMode} onChange={(e)=> setSortMode(e.target.value)}
                  style={{ background:'#1e293b', border:'1px solid #334155', color:'#e2e8f0', padding:'0.45rem 0.6rem', borderRadius:'8px' }}>
                  <option value="priority_age">Priority + Age</option>
                  <option value="age">Age</option>
                  <option value="room">Room</option>
                  <option value="item">Item</option>
                </select>

                <div style={{ color:'#64748b', fontSize:'0.8rem' }}>
                  Actions: {canWarehouseAct ? <span style={{ color:'#00ff88', fontWeight:900 }}>enabled</span> : <span style={{ color:'#fbbf24', fontWeight:900 }}>read-only</span>}
                </div>
              </div>

              {grouped.keys.length === 0 ? (
                <div style={{ padding:'4rem 2rem', textAlign:'center', background:'rgba(15,23,42,0.85)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'14px' }}>
                  <Package size={64} color="#334155" />
                  <h3 style={{ color:'#64748b', margin:'1rem 0 0 0' }}>No requests</h3>
                </div>
              ) : (
                <div style={{ display:'flex', flexDirection:'column', gap:'1rem' }}>
                  {grouped.keys.map(groupKey => (
                    <div key={groupKey} style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'14px', overflow:'hidden' }}>
                      <div style={{ padding:'0.9rem 1.2rem', background:'linear-gradient(135deg, rgba(0,255,136,0.15) 0%, rgba(0,255,136,0.04) 100%)', borderBottom:'2px solid #00ff88', display:'flex', alignItems:'center', gap:'0.75rem' }}>
                        <MapPin size={20} color="#00ff88" />
                        <div style={{ color:'#00ff88', fontWeight:900, textTransform:'uppercase', letterSpacing:'0.09em' }}>{groupKey}</div>
                        <div style={{ marginLeft:'auto', color:'#8b9dc3', fontSize:'0.85rem' }}>{grouped.map[groupKey].length}</div>
                      </div>

                      <div style={{ overflowX:'auto' }}>
                        <table style={{ width:'100%', borderCollapse:'collapse', minWidth:'1050px' }}>
                          <thead>
                            <tr style={{ background:'rgba(0,255,136,0.05)' }}>
                              <th style={headerStyle}>SLA</th>
                              <th style={headerStyle}>Item</th>
                              <th style={headerStyle}>Room</th>
                              <th style={headerStyle}>Req / Adj</th>
                              <th style={headerStyle}>Submitted</th>
                              <th style={headerStyle}>Claimed</th>
                              <th style={headerStyle}>Priority</th>
                              <th style={headerStyle}>Comments</th>
                              <th style={headerStyle}>Status</th>
                              <th style={headerStyle}>Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {grouped.map[groupKey].map((req, idx) => {
                              const sla = slaBadge(req);
                              const statusColor =
                                req.status==="pending" ? "#fbbf24" :
                                req.status==="claimed" ? "#38bdf8" :
                                req.status==="in_progress" ? "#a78bfa" :
                                req.status==="completed" ? "#00ff88" :
                                "#ff4444";

                              const lockedByOther = !!req.claimedBy && req.claimedBy !== userName && !canSupervisor;
                              const canActThis = canWarehouseAct && !lockedByOther && req.status !== "completed" && req.status !== "cancelled";

                              return (
                                <tr key={req.id} style={{ borderBottom: idx < grouped.map[groupKey].length-1 ? '1px solid #334155' : 'none', opacity: req.status==="completed" ? 0.65 : 1 }}>
                                  <td style={cellStyle}>
                                    <span style={{ display:'inline-block', padding:'0.25rem 0.6rem', borderRadius:'10px', background:sla.bg, color:sla.fg, fontWeight:900, fontSize:'0.75rem' }}>
                                      {sla.label}
                                    </span>
                                  </td>

                                  <td style={cellStyle}>
                                    <div style={{ display:'flex', alignItems:'center', gap:'0.5rem' }}>
                                      <Package size={16} color="#00ff88" />
                                      <span style={{ fontWeight:900 }}>{req.item}</span>
                                    </div>
                                  </td>

                                  <td style={cellStyle}>
                                    <span style={{ color:'#00ff88', fontWeight:900 }}>{req.room}</span>
                                  </td>

                                  <td style={cellStyle}>
                                    <span style={{ padding:'0.2rem 0.55rem', background:'#1e293b', borderRadius:'10px', fontWeight:900, color:'#00ff88' }}>{req.qty}</span>
                                    <span style={{ color:'#64748b', margin:'0 0.4rem' }}>/</span>
                                    {editingId === req.id ? (
                                      <span style={{ display:'inline-flex', gap:'0.4rem', alignItems:'center' }}>
                                        <input type="number" value={editQty} onChange={(e)=> setEditQty(parseInt(e.target.value)||0)}
                                          style={{ width:'80px', padding:'0.35rem', background:'#1e293b', border:'2px solid #00ff88', borderRadius:'8px', color:'#e2e8f0', fontWeight:900 }} />
                                        <button disabled={!canActThis} onClick={()=> adjustQty(req.id, editQty)}
                                          style={{ opacity: canActThis ? 1 : 0.5, padding:'0.35rem 0.55rem', background:'#00ff88', border:'none', borderRadius:'8px', cursor: canActThis ? 'pointer' : 'not-allowed' }}>
                                          <Save size={16} color="#0a0e1a" />
                                        </button>
                                      </span>
                                    ) : (
                                      <span style={{ display:'inline-flex', gap:'0.4rem', alignItems:'center' }}>
                                        <span style={{
                                          padding:'0.2rem 0.55rem',
                                          background: (req.adjQty && req.adjQty>0) ? '#fbbf24' : '#334155',
                                          borderRadius:'10px',
                                          fontWeight:900,
                                          color: (req.adjQty && req.adjQty>0) ? '#0a0e1a' : '#64748b'
                                        }}>
                                          {req.adjQty && req.adjQty>0 ? req.adjQty : '-'}
                                        </span>
                                        {canActThis && (
                                          <button onClick={() => { setEditingId(req.id); setEditQty(req.adjQty || req.qty); }}
                                            style={{ padding:'0.25rem', background:'transparent', border:'1px solid #334155', borderRadius:'8px', cursor:'pointer' }}>
                                            <Edit2 size={14} color="#64748b" />
                                          </button>
                                        )}
                                      </span>
                                    )}
                                  </td>

                                  <td style={cellStyle}>
                                    <div style={{ fontSize:'0.78rem', color:'#8b9dc3' }}>
                                      <div style={{ display:'flex', alignItems:'center', gap:'0.35rem' }}>
                                        <Clock size={14} color="#64748b" />
                                        <span>{niceTime(req.submittedAt)}</span>
                                      </div>
                                      <div style={{ marginTop:'0.25rem', color:'#00ff88', fontWeight:900 }}>{req.submittedBy || "?"}</div>
                                    </div>
                                  </td>

                                  <td style={cellStyle}>
                                    {req.claimedBy ? (
                                      <div style={{ fontSize:'0.78rem' }}>
                                        <div style={{ color: lockedByOther ? '#fbbf24' : '#38bdf8', fontWeight:900 }}>
                                          {req.claimedBy}{lockedByOther ? " üîí" : ""}
                                        </div>
                                        <div style={{ color:'#64748b' }}>{req.claimedAt ? niceTime(req.claimedAt) : ""}</div>
                                      </div>
                                    ) : (
                                      <span style={{ color:'#475569' }}>‚Äî</span>
                                    )}
                                  </td>

                                  <td style={cellStyle}>
                                    {req.priority ? (
                                      <span style={{ padding:'0.25rem 0.6rem', background:'#ff4444', borderRadius:'10px', color:'#fff', fontWeight:900, fontSize:'0.75rem' }}>HIGH</span>
                                    ) : (
                                      <span style={{ color:'#64748b', fontSize:'0.85rem' }}>Normal</span>
                                    )}
                                  </td>

                                  <td style={cellStyle}>
                                    {req.comments ? (
                                      <span title={req.comments} style={{ color:'#8b9dc3', maxWidth:'240px', display:'inline-block', overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap' }}>
                                        {req.comments}
                                      </span>
                                    ) : <span style={{ color:'#475569' }}>‚Äî</span>}
                                  </td>

                                  <td style={cellStyle}>
                                    <span style={{ display:'inline-flex', gap:'0.4rem', alignItems:'center', padding:'0.25rem 0.6rem', borderRadius:'10px', background:statusColor, color:'#0a0e1a', fontWeight:900, fontSize:'0.75rem', textTransform:'uppercase' }}>
                                      {req.status.replace("_"," ")}
                                    </span>
                                    {req.status === "completed" && req.completedAt && (
                                      <div style={{ marginTop:'0.35rem', color:'#00ff88', fontSize:'0.75rem', fontWeight:900 }}>
                                        ‚úì {niceTime(req.completedAt)}{req.completedBy ? ` by ${req.completedBy}` : ""}
                                      </div>
                                    )}
                                  </td>

                                  <td style={cellStyle}>
                                    <div style={{ display:'flex', gap:'0.4rem', flexWrap:'wrap' }}>
                                      {req.status === "pending" && (
                                        <button disabled={!canActThis} onClick={()=> claimRequest(req.id)}
                                          style={{ opacity: canActThis ? 1 : 0.45, padding:'0.45rem 0.7rem', background:'#38bdf8', border:'none', borderRadius:'10px', fontWeight:900, cursor: canActThis ? 'pointer' : 'not-allowed' }}>
                                          Claim
                                        </button>
                                      )}
                                      {(req.status === "claimed" || req.status === "pending") && (
                                        <button disabled={!canActThis} onClick={()=> startRequest(req.id)}
                                          style={{ opacity: canActThis ? 1 : 0.45, padding:'0.45rem 0.7rem', background:'#a78bfa', border:'none', borderRadius:'10px', fontWeight:900, cursor: canActThis ? 'pointer' : 'not-allowed' }}>
                                          Start
                                        </button>
                                      )}
                                      {(req.status === "in_progress" || req.status === "claimed") && (
                                        <button disabled={!canActThis} onClick={()=> completeRequest(req.id)}
                                          style={{ opacity: canActThis ? 1 : 0.45, padding:'0.45rem 0.7rem', background:'linear-gradient(135deg, #00ff88 0%, #00cc6f 100%)', border:'none', borderRadius:'10px', fontWeight:900, cursor: canActThis ? 'pointer' : 'not-allowed', display:'inline-flex', alignItems:'center', gap:'0.25rem' }}>
                                          <CheckCircle size={14} color="#0a0e1a" /> Done
                                        </button>
                                      )}
                                      {req.status !== "completed" && req.status !== "cancelled" && (
                                        <button disabled={!canActThis} onClick={()=> cancelRequest(req.id)}
                                          style={{ opacity: canActThis ? 1 : 0.45, padding:'0.45rem 0.55rem', background:'transparent', border:'1px solid #ff4444', borderRadius:'10px', cursor: canActThis ? 'pointer' : 'not-allowed' }}>
                                          <XCircle size={14} color={canActThis ? "#ff4444" : "#64748b"} />
                                        </button>
                                      )}
                                    </div>
                                  </td>
                                </tr>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        );
      }

      // FORM (Room submits)
      return (
        <div style={{ minHeight:'100vh', ...bg, padding:'1.5rem', position:'relative', overflow:'hidden' }}>
          <div style={gridOverlay} />
          <div style={{ maxWidth:'780px', margin:'0 auto', position:'relative', zIndex:1 }}>
            <TopBar title="Delivery Request" subtitle={`üë§ ${userName} (${userRole}) ‚Ä¢ ${connectionMode === "supabase" ? "Supabase ready ‚Ä¢ Realtime" : "Local + kiosk mode"}`} />

            <div style={{ marginBottom:'0.9rem', padding:'0.65rem 0.9rem', background:'rgba(0,255,136,0.1)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'10px', color:'#00ff88', fontSize:'0.75rem', textAlign:'center', letterSpacing:'0.05em' }}>
              ‚ÑπÔ∏è Submitting creates a shared request visible instantly
            
            {successMsg && (
              <div style={{ marginTop:'0.75rem', padding:'0.75rem 1rem', background:'rgba(0,255,136,0.12)', border:'1px solid rgba(0,255,136,0.25)', borderRadius:'10px', color:'#00ff88', fontSize:'0.85rem', fontWeight:700, letterSpacing:'0.04em', textAlign:'center' }}>
                {successMsg}
              </div>
            )}
</div>

            <form onSubmit={submitRequest} style={{ background:'rgba(15,23,42,0.85)', border:'1px solid rgba(0,255,136,0.2)', borderRadius:'14px', padding:'2rem', boxShadow:'0 8px 32px rgba(0,0,0,0.28)' }}>
              <div style={{ marginBottom:'1.1rem' }}>
                <label style={{ display:'flex', alignItems:'center', gap:'0.5rem', color:'#e2e8f0', fontSize:'0.85rem', fontWeight:900, marginBottom:'0.5rem', textTransform:'uppercase', letterSpacing:'0.05em' }}>
                  <Package size={16} color="#00ff88" /> Item <span style={{ color:'#00ff88' }}>*</span>
                </label>
                <input
                  value={formData.item}
                  onChange={(e)=> setFormData({ ...formData, item: e.target.value })}
                  style={{ width:'100%', padding:'0.875rem', background:'#1e293b', border:`2px solid ${errors.item ? '#ff4444' : (formData.item ? '#00ff88' : '#334155')}`, borderRadius:'10px', color:'#e2e8f0', fontSize:'1rem', outline:'none' }}
                  placeholder="e.g., Film rolls"
                />
                {errors.item && <div style={{ marginTop:'0.35rem', color:'#ff4444', fontSize:'0.78rem', display:'flex', gap:'0.35rem', alignItems:'center' }}><AlertCircle size={12} /> {errors.item}</div>}
              </div>

              <div style={{ marginBottom:'1.1rem', position:'relative' }} ref={dropdownRef}>
                <label style={{ display:'flex', alignItems:'center', gap:'0.5rem', color:'#e2e8f0', fontSize:'0.85rem', fontWeight:900, marginBottom:'0.5rem', textTransform:'uppercase', letterSpacing:'0.05em' }}>
                  <MapPin size={16} color="#00ff88" /> Room <span style={{ color:'#00ff88' }}>*</span>
                </label>

                <div onClick={()=> setRoomDropdownOpen(!roomDropdownOpen)}
                  style={{ width:'100%', padding:'0.875rem', background:'#1e293b', border:`2px solid ${errors.room ? '#ff4444' : (formData.room ? '#00ff88' : '#334155')}`, borderRadius:'10px', color: formData.room ? '#e2e8f0' : '#64748b', cursor:'pointer', display:'flex', justifyContent:'space-between', alignItems:'center' }}>
                  <span>{formData.room || "Select room‚Ä¶"}</span>
                  <span style={{ color:'#00ff88', transform: roomDropdownOpen ? 'rotate(180deg)' : 'rotate(0deg)', transition:'transform 0.2s ease' }}>‚ñº</span>
                </div>
                {errors.room && <div style={{ marginTop:'0.35rem', color:'#ff4444', fontSize:'0.78rem', display:'flex', gap:'0.35rem', alignItems:'center' }}><AlertCircle size={12} /> {errors.room}</div>}

                {roomDropdownOpen && (
                  <div style={{ position:'absolute', top:'100%', left:0, right:0, marginTop:'0.5rem', background:'#1e293b', border:'2px solid #00ff88', borderRadius:'10px', boxShadow:'0 12px 28px rgba(0,255,136,0.15)', zIndex:10, overflow:'hidden' }}>
                    <input value={roomSearch} onChange={(e)=> setRoomSearch(e.target.value)} onClick={(e)=> e.stopPropagation()}
                      placeholder="Search rooms‚Ä¶"
                      style={{ width:'100%', padding:'0.75rem', background:'#0f172a', border:'none', borderBottom:'1px solid #334155', color:'#e2e8f0', outline:'none' }} />
                    {filteredRooms.map((room, idx) => (
                      <div key={room} onClick={()=> { setFormData({ ...formData, room }); setRoomDropdownOpen(false); setRoomSearch(""); }}
                        style={{ padding:'0.85rem', cursor:'pointer', color:'#e2e8f0', borderBottom: idx < filteredRooms.length-1 ? '1px solid #334155' : 'none' }}
                        onMouseEnter={(e)=> { e.currentTarget.style.background='rgba(0,255,136,0.1)'; e.currentTarget.style.color='#00ff88'; }}
                        onMouseLeave={(e)=> { e.currentTarget.style.background='transparent'; e.currentTarget.style.color='#e2e8f0'; }}
                      >
                        {room}
                      </div>
                    ))}
                  </div>
                )}
              </div>

              <div style={{ display:'grid', gridTemplateColumns:'1fr 1fr', gap:'1rem', marginBottom:'1.1rem' }}>
                <div>
                  <label style={{ display:'block', color:'#e2e8f0', fontSize:'0.85rem', fontWeight:900, marginBottom:'0.5rem', textTransform:'uppercase', letterSpacing:'0.05em' }}>
                    Qty <span style={{ color:'#00ff88' }}>*</span>
                  </label>
                  <input type="number" value={formData.qty} onChange={(e)=> setFormData({ ...formData, qty: parseInt(e.target.value)||0 })}
                    style={{ width:'100%', padding:'0.875rem', background:'#1e293b', border:`2px solid ${errors.qty ? '#ff4444' : '#334155'}`, borderRadius:'10px', color:'#e2e8f0', fontSize:'1rem', outline:'none' }} />
                  {errors.qty && <div style={{ marginTop:'0.35rem', color:'#ff4444', fontSize:'0.78rem', display:'flex', gap:'0.35rem', alignItems:'center' }}><AlertCircle size={12} /> {errors.qty}</div>}
                </div>

                <div>
                  <label style={{ display:'block', color:'#e2e8f0', fontSize:'0.85rem', fontWeight:900, marginBottom:'0.5rem', textTransform:'uppercase', letterSpacing:'0.05em' }}>
                    Priority
                  </label>
                  <div style={{ display:'flex', gap:'0.5rem' }}>
                    {[
                      { key:false, label:"Normal", bg:"#1e293b", border:"#334155", color:"#e2e8f0" },
                      { key:true, label:"High", bg:"linear-gradient(135deg, #ff4444 0%, #cc0000 100%)", border:"#ff4444", color:"#fff" }
                    ].map(opt => (
                      <button key={String(opt.key)} type="button"
                        onClick={()=> setFormData({ ...formData, priority: opt.key })}
                        style={{
                          flex:1, padding:'0.875rem', borderRadius:'10px',
                          background: formData.priority === opt.key ? opt.bg : "#1e293b",
                          border: formData.priority === opt.key ? `2px solid ${opt.border}` : "2px solid #334155",
                          color: formData.priority === opt.key ? opt.color : "#e2e8f0",
                          fontWeight:900, cursor:'pointer', textTransform:'uppercase', letterSpacing:'0.06em'
                        }}
                      >
                        {opt.label}
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              <div style={{ marginBottom:'1.1rem' }}>
                <label style={{ display:'flex', alignItems:'center', gap:'0.5rem', color:'#e2e8f0', fontSize:'0.85rem', fontWeight:900, marginBottom:'0.5rem', textTransform:'uppercase', letterSpacing:'0.05em' }}>
                  <MessageSquare size={16} color="#00ff88" /> Comments
                </label>
                <textarea value={formData.comments} onChange={(e)=> setFormData({ ...formData, comments:e.target.value })}
                  rows={4}
                  style={{ width:'100%', padding:'0.875rem', background:'#1e293b', border:'2px solid #334155', borderRadius:'10px', color:'#e2e8f0', outline:'none', resize:'vertical' }}
                  placeholder="Any notes (size, urgency reason, where to drop, etc.)"
                />
              </div>

              <button type="submit"
                style={{ width:'100%', padding:'1.1rem', background:'linear-gradient(135deg, #00ff88 0%, #00cc6f 100%)', border:'none', borderRadius:'12px', color:'#0a0e1a', fontSize:'1.05rem', fontWeight:900, cursor:'pointer', textTransform:'uppercase', letterSpacing:'0.08em', boxShadow:'0 4px 18px rgba(0,255,136,0.35)' }}>
                Submit Request
              </button>

              {userRole === "room" && (
                <div style={{ marginTop:'1rem', color:'#64748b', fontSize:'0.8rem' }}>
                  Room role is submit + view only. Warehouse/Supervisor handle claiming and completion.
                </div>
              )}
            </form>
          </div>
        </div>
      );
    }

    ReactDOM.render(<WarehouseDeliveryApp />, document.getElementById("root"));
  </script>

  <script>
    // PWA service worker (works on https or localhost)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(() => {});
      });
    }
  </script>

</body>
</html>
